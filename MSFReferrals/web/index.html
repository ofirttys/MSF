<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSF Referrals Management Dashboard</title>
    
    <!-- Flatpickr CSS for date pickers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f3ebff;
            color: #2c3e50;
            line-height: 1.6;
        }

        /* Login Screen Styles */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: block;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .error-message {
            background: #ffe6e6;
            color: #c0392b;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        /* Main App Styles */
        #mainApp {
            display: none;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Read-only Banner */
        #readOnlyBanner {
            display: none;
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        /* Header */
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h1 {
            color: #2c3e50;
            font-size: 24px;
        }

        .user-info {
            color: #7f8c8d;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .unsaved-indicator {
            color: #e74c3c;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }

        /* Controls Bar */
        .controls-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-group label {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
            min-height: 600px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .content-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Referral List */
        .referral-list {
            max-height: 700px;
            overflow-y: auto;
        }

        .referral-item {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .referral-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .referral-left {
            flex: 1;
            min-width: 0;
        }

        .referral-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .referral-patient-name {
            font-weight: 600;
            font-size: 14px;
        }

        .referral-id {
            color: #7f8c8d;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-new {
            background: #e74c3c;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .status-info-received {
            background: #3498db;
            color: white;
        }

        .status-deferred {
            background: #95a5a6;
            color: white;
        }

        .status-completed {
            background: #27ae60;
            color: white;
        }

        .referral-info {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            gap: 15px;
            margin-top: 3px;
        }

        .referral-actions {
            display: flex;
            gap: 5px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content.large {
            max-width: 1000px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #95a5a6;
        }

        .close-btn:hover {
            color: #7f8c8d;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* History List */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .history-date {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
        }

        .history-content {
            font-size: 13px;
            color: #2c3e50;
            margin-top: 3px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Utility Classes */
        .text-muted {
            color: #7f8c8d;
        }

        .text-danger {
            color: #e74c3c;
        }

        .text-success {
            color: #27ae60;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <?xml version="1.0" encoding="utf-8" ?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="80" height="80" viewBox="0 0 550 550"><path fill="#25ABE2" d="M17.1205 215.804C15.2512 213.98 3.89954 203.277 3.13166 201.696C3.96746 200.496 24.4409 195.072 28.0857 194.008L91.6641 175.791C93.3297 177.763 96.1202 183.18 97.646 185.723L98.7692 187.74L119.526 223.648C122.105 228.114 127.284 236.4 129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C81.9393 277.931 77.2785 273.737 73.1017 269.721L48.3392 245.87C40.9193 238.772 31.7108 229.121 24.1798 222.583C21.8072 220.223 19.5985 218.055 17.1205 215.804Z"/><path fill="#DC2C29" d="M129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C87.1982 281.299 95.6147 272.942 97.4191 271.243C108.068 261.219 118.524 250.489 129.305 240.615Z"/><path fill="#25ABE2" d="M369.669 96.1737C390.971 89.8571 412.76 83.9982 434.135 77.819C445.726 74.4681 458.042 70.5393 469.736 67.8083C469.149 70.0459 468.652 72.4249 468.142 74.6904L467.243 78.0757L454.223 129.716C451.905 139.071 449.754 148.715 447.126 157.969C442.855 157.616 437.793 157.734 433.433 157.734L412.978 157.735L389.211 157.747C384.728 157.751 379.386 157.63 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525L360.624 98.78C363.462 98.0718 366.819 97.005 369.669 96.1737Z"/><path fill="#DC2C29" d="M360.524 98.6525L360.624 98.78C360.761 101.314 362.888 108.581 363.542 111.429C366.043 122.318 369.125 133.191 371.703 144.072C372.763 148.543 374.155 153.453 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525Z"/><path fill="#25ABE2" d="M104.112 386.16C111.597 386.015 119.966 386.213 127.545 386.213L176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C187.521 445.778 182.293 447.477 179.194 448.359L155.893 455.087L94.4803 472.686C90.2246 473.945 85.7043 475.096 81.4007 476.217C82.8134 470.922 83.9962 465.165 85.3475 459.788L98.104 408.939C99.2889 404.23 102.39 389.669 104.112 386.16Z"/><path fill="#DC2C29" d="M176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C190.428 443.052 187.171 430.895 186.441 428.062L180.18 403.006C178.829 397.617 177.118 391.586 176.054 386.187Z"/><path fill="#25ABE2" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477L378.039 434.64L370.03 467.376C368.589 472.632 367.186 477.946 365.947 483.253C363.145 495.261 359.871 507.142 356.999 519.129L354.179 530.761L354.102 531.004C353.529 532.862 353.031 536.843 351.899 537.871C351.266 537.814 351.415 537.849 350.796 537.658C349.588 535.643 338.013 525.074 335.621 522.779L299.149 487.61L296.613 485.188C293.114 482.08 289.776 478.469 286.105 475.225C293.923 460.334 303.253 445.792 311.441 431.071C313.892 426.665 316.587 421.702 319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#DC2C29" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477C373.436 432.869 366.713 431.253 361.94 429.855L319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#25ABE2" d="M198.84 5.58799C204.614 10.4081 209.89 15.8699 215.324 21.098L241.962 46.7938L254.143 58.482C256.254 60.5282 262.475 66.7839 264.51 68.2112C264.663 69.1602 264.801 69.0228 264.298 69.9266C262.266 73.5786 260.092 77.2522 257.997 80.8644L245.789 101.968L236.682 117.729C235.28 120.161 233.184 124.266 231.516 126.413C228.522 125.2 219.738 122.888 216.37 121.921L186.351 113.342C183.252 112.462 175.686 110.555 172.99 109.411C176.973 92.0214 181.67 74.6125 185.906 57.2838L193.505 27.0218C195.233 20.0162 196.854 12.4681 198.84 5.58799Z"/><path fill="#FDAF19" d="M101.486 88.8467C104.016 89.7253 106.587 90.3149 109.161 91.0514L123.884 95.2716L153.812 103.814C159.099 105.305 167.755 107.541 172.725 109.411L172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C123.926 157.895 120.533 157.757 118.581 158.138C118.16 156.994 117.376 153.144 117.061 151.778C116.101 147.618 115.155 143.529 114.107 139.381L101.486 88.8467Z"/><path fill="#DC2C29" d="M172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C129.058 157.544 135.273 157.693 138.467 157.69L161.179 157.701C162.04 152.138 173.361 111.269 172.725 109.411L172.99 109.411Z"/><path fill="#FDAF19" d="M85.9258 282.128C89.0077 284.428 93.9369 289.446 96.8382 292.254L114.218 309.054C115.981 310.766 119.96 314.857 121.739 316.272C119.502 320.512 117.024 324.518 114.625 328.653C114.074 329.602 111.899 333.24 111.599 334.097C110.539 335.775 108.955 338.453 108.051 340.281C107.367 341.236 107.098 341.664 106.565 342.709C104.882 345.583 103.066 348.554 101.579 351.521C100.777 352.772 100.042 354.689 98.9702 355.118C97.2535 354.208 89.1585 351.975 86.9382 351.321L52.0742 341.324L48.3624 340.312C42.521 338.72 36.7055 336.957 30.9004 335.232C32.7025 333.091 35.2179 330.575 37.2664 328.618C51.3496 315.166 65.162 301.379 79.4367 288.137C81.4919 286.231 83.7705 283.805 85.9258 282.128Z"/><path fill="#FDAF19" d="M390.536 386.207L418.33 386.207C422.11 386.2 428.82 385.982 432.35 386.263C433.135 388.921 433.822 391.439 434.519 394.117L436.412 401.952C438.238 409.88 440.271 417.772 442.356 425.637C442.7 426.935 442.989 428.258 443.416 429.531C443.599 430.626 443.739 431.377 444.031 432.445C445.09 437.198 447.728 449.194 449.352 453.407L449.596 454.382L449.427 454.716C448.083 455.162 437.772 451.723 435.814 451.174L397.876 440.419C393.818 439.287 389.181 437.707 385.189 436.736C382.921 435.868 380.399 435.266 378.039 434.64L377.944 434.477C379.211 430.103 380.379 424.5 381.498 419.991L389.317 388.58C389.699 387.064 389.522 386.822 390.536 386.207Z"/><path fill="#FDAF19" d="M293.645 81.5672C298.241 76.1306 304.384 71.4223 309.44 66.4096C315.677 60.6778 321.485 53.6435 327.918 48.188C333.325 43.6033 338.534 37.6884 343.95 33.4048C345.173 36.1096 347.095 44.1829 347.945 47.4432C348.075 47.96 348.552 50.0487 348.748 50.3843C348.955 51.4388 349.154 52.5725 349.395 53.6123C351.202 61.3387 353.199 69.0207 355.209 76.6973C355.589 78.146 355.942 79.7492 356.408 81.1647C357.326 86.4982 359.215 93.2727 360.524 98.6525C357.689 100.939 318.472 110.484 311.753 113.078C308.598 108.386 304.958 101.422 301.966 96.3799C299.734 92.6201 295.381 85.3541 293.645 81.5672Z"/><path fill="#FDAF19" d="M239.269 430.708L251.532 451.853C252.541 453.594 255.965 459.808 257.046 461.148C257.174 461.927 257.392 462.136 256.9 462.644C254.487 465.134 251.695 467.75 249.206 470.143L229.338 489.284C227.751 490.811 221.269 496.808 220.147 498.213C219.197 499.097 215.312 502.681 214.766 503.471C213.474 504.616 207.762 510.415 206.84 510.59C205.616 507.49 203.56 497.663 202.619 493.859L193.885 459.067C193.577 457.622 193.287 456.451 192.893 455.026C192.582 453.586 192.4 452.615 191.863 451.223C191.612 449.548 190.978 447.102 190.591 445.393C190.699 445.235 190.808 445.077 190.916 444.919C204.77 440.608 219.228 436.842 233.099 432.704C236.705 431.628 237.355 431.701 239.269 430.708Z"/><path fill="#25ABE2" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C468.441 265.221 474.007 270.912 477.403 273.671C487.898 284.224 499.362 294.866 510.098 305.223C521.591 316.309 533.226 327.867 544.865 338.759C545.611 339.475 547.258 341.187 548.082 341.586L548.31 342.415C547.799 343.112 546.929 343.148 545.918 343.443L542.434 344.438L504.138 355.382C502.972 355.687 501.468 356.027 500.364 356.428C499.101 356.683 497.879 357.007 496.651 357.393C486.574 360.566 476.253 363.13 466.161 366.204C464.258 366.783 461.069 367.834 459.222 368.14C454.784 360.817 450.302 352.778 446.001 345.334L421.784 303.437L403.624 272.104Z"/><path fill="#DC2C29" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C462.097 264.164 454.938 271.664 451.919 274.492C441.848 283.922 431.941 294.133 421.784 303.437L403.624 272.104Z"/><path fill="#FDAF19" d="M451.487 189.086C455.312 190.444 462.169 192.077 466.53 193.38C484.248 198.676 502.576 203.39 520.258 208.744C518.42 210.635 516.561 212.437 514.67 214.272C511.351 217.055 506.557 222.008 503.291 225.183L465.133 261.937C462.623 260.08 456.016 253.452 453.494 251.027L429.28 227.577C435.69 216.108 442.389 204.801 448.895 193.387C449.724 191.932 450.597 190.504 451.487 189.086Z"/><defs><linearGradient id="gradient_0" gradientUnits="userSpaceOnUse" x1="546.82275" y1="339.83099" x2="547.7254" y2="338.84558"><stop offset="0" stop-color="#000100" stop-opacity="0"/><stop offset="1" stop-color="black" stop-opacity="0"/></linearGradient></defs><path fill="url(#gradient_0)" d="M544.865 338.759L545.184 337.715C544.856 337.4 544.641 337.149 544.402 336.762L544.579 336.506C545.334 336.712 546.84 338.461 547.475 339.127C547.576 338.613 547.603 338.383 547.64 337.86C548.778 338.509 548.795 340.816 550 341.438L550 343.301C548.603 342.294 549.661 342.12 548.082 341.586C547.258 341.187 545.611 339.475 544.865 338.759Z"/></svg>
                <h1>MSF Referrals Management</h1>
                <p>Please login to continue</p>
            </div>
            
            <div id="loginError" class="error-message"></div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp">
        <!-- Read-Only Banner -->
        <div id="readOnlyBanner">
            üîí READ-ONLY MODE - Database is being edited by <span id="lockOwnerName"></span>
        </div>

        <!-- Header -->
        <header>
            <div class="header-top">
                <div class="header-title">
                    <h1>MSF Referrals Management Dashboard</h1>
                    <div class="user-info">
                        Logged in as: <strong id="currentUsername"></strong>
                    </div>
                </div>
                
                <div class="header-actions">
                    <span id="unsavedIndicator" class="unsaved-indicator">‚óè Unsaved changes</span>
                    <button onclick="saveDatabase()" class="btn btn-success" id="saveButton">Save</button>
                    <button onclick="logout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>
            
            <div class="controls-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search referrals..." oninput="filterReferrals()">
                </div>
                
                <div class="control-group">
                    <label>Sort:</label>
                    <select id="sortSelect" onchange="filterReferrals()">
                        <option value="name-az">Name A‚ÜíZ</option>
                        <option value="attempt-old">Last Attempt (Old‚ÜíNew)</option>
                        <option value="attempt-new">Last Attempt (New‚ÜíOld)</option>
                        <option value="received-new">Received (New‚ÜíOld)</option>
                        <option value="received-old">Received (Old‚ÜíNew)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Filter:</label>
                    <select id="filterSelect" onchange="filterReferrals()">
                        <option value="all">All</option>
                        <option value="new">New</option>
                        <option value="pending">Pending</option>
                        <option value="info-received">All Information Received</option>
                        <option value="deferred">Deferred</option>
                        <option value="completed">Completed</option>
                        <option value="contact-2days">Contact > 2 days</option>
                        <option value="contact-3days">Contact > 3 days</option>
                        <option value="contact-7days">Contact > 7 days</option>
                        <option value="missing-contact">Missing Contact Time</option>
                    </select>
                </div>
                
                <button onclick="openAddReferralModal()" class="btn btn-primary" id="addReferralBtn">
                    + Add Referral
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="content-title">
                    Referrals (<span id="referralCount">0</span>)
                </div>
            </div>
            
            <div class="referral-list" id="referralList">
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <div class="empty-state-text">No referrals found</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Referral Modal -->
    <div id="referralModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title" id="referralModalTitle">Add New Referral</h2>
                <button class="close-btn" onclick="closeModal('referralModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="referralForm">
                    <!-- Referral Information -->
                    <div class="form-section">
                        <div class="form-section-title">Referral Information</div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Referral Date</label>
                                <input type="text" id="referralDate" class="datepicker">
                            </div>
                            <div class="form-group">
                                <label>Received Date</label>
                                <input type="text" id="receivedDate" class="datepicker">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>File Name</label>
                                <input type="text" id="fileName">
                            </div>
                            <div class="form-group">
                                <label>Referring Physician</label>
                                <select id="referringPhysician" onchange="updatePhysicianInfo()">
                                    <option value="">Select physician...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Billing Number</label>
                                <input type="text" id="billingNumber">
                            </div>
                            <div class="form-group">
                                <label>Fax</label>
                                <input type="text" id="physicianFax">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" id="physicianPhone">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="physicianEmail">
                            </div>
                        </div>
                    </div>

                    <!-- Service Information -->
                    <div class="form-section">
                        <div class="form-section-title">Service Information</div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Requested Location</label>
                                <select id="requestedLocation">
                                    <option value="">Select location...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Requested Physician</label>
                                <select id="requestedPhysician">
                                    <option value="">Select physician...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="urgent">
                                <label for="urgent">Urgent</label>
                            </div>
                            <div class="form-group">
                                <label>New/Previous/Partner</label>
                                <select id="newPrevPartner">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Service Requested</label>
                                <select id="serviceRequested">
                                    <option value="">Select service...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sub Service Requested</label>
                                <input type="text" id="subServiceRequested">
                            </div>
                        </div>
                    </div>

                    <!-- Patient Information -->
                    <div class="form-section">
                        <div class="form-section-title">Patient Information</div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>PID</label>
                                <input type="text" id="patientPID">
                            </div>
                            <div class="form-group">
                                <label>MRN</label>
                                <input type="text" id="patientMRN">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" id="patientFirstName">
                            </div>
                            <div class="form-group">
                                <label>Middle Name</label>
                                <input type="text" id="patientMiddleName">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" id="patientLastName">
                            </div>
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="text" id="patientDOB" class="datepicker">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="patientPhone">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="patientEmail">
                            </div>
                        </div>
                        
                        <div class="form-row full">
                            <div class="form-group">
                                <label>Address</label>
                                <input type="text" id="patientAddress">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Health Card</label>
                                <input type="text" id="patientHC">
                            </div>
                            <div class="form-group">
                                <label>Gender at Birth</label>
                                <select id="patientGender">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Partner Information -->
                    <div class="form-section">
                        <div class="form-section-title">Partner Information</div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>PID</label>
                                <input type="text" id="partnerPID">
                            </div>
                            <div class="form-group">
                                <label>MRN</label>
                                <input type="text" id="partnerMRN">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" id="partnerFirstName">
                            </div>
                            <div class="form-group">
                                <label>Middle Name</label>
                                <input type="text" id="partnerMiddleName">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" id="partnerLastName">
                            </div>
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="text" id="partnerDOB" class="datepicker">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="partnerPhone">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="partnerEmail">
                            </div>
                        </div>
                        
                        <div class="form-row full">
                            <div class="form-group">
                                <label>Address</label>
                                <input type="text" id="partnerAddress">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Health Card</label>
                                <input type="text" id="partnerHC">
                            </div>
                            <div class="form-group">
                                <label>Gender at Birth</label>
                                <select id="partnerGender">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button onclick="closeModal('referralModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="saveReferral()" class="btn btn-success" id="saveReferralBtn">Save Referral</button>
            </div>
        </div>
    </div>

    <!-- View/Edit Referral Modal -->
    <div id="viewReferralModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title">Referral Details - <span id="viewReferralTitle"></span></h2>
                <button class="close-btn" onclick="closeModal('viewReferralModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('details')">Details</button>
                    <button class="tab" onclick="switchTab('history')">Contact History</button>
                    <button class="tab" onclick="switchTab('notes')">Notes</button>
                </div>
                
                <div id="tabDetails" class="tab-content active">
                    <div id="referralDetails"></div>
                    
                    <div class="modal-footer" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                        <button onclick="editReferral()" class="btn btn-primary" id="editReferralBtn">Edit</button>
                        <button onclick="openContactModal()" class="btn btn-success" id="contactBtn">Contact Attempt</button>
                        <button onclick="emailPatient()" class="btn btn-primary" id="emailBtn">Email Patient</button>
                        <button onclick="faxPhysician()" class="btn btn-primary" id="faxBtn">Fax Referring Physician</button>
                        <button onclick="markInfoReceived()" class="btn btn-success" id="infoReceivedBtn">All Info Received</button>
                        <button onclick="openAssignAdminModal()" class="btn btn-success" id="assignAdminBtn">Assign to Admin</button>
                    </div>
                </div>
                
                <div id="tabHistory" class="tab-content">
                    <div class="history-list" id="contactHistoryList">
                        <div class="empty-state">
                            <div class="empty-state-text">No contact history</div>
                        </div>
                    </div>
                </div>
                
                <div id="tabNotes" class="tab-content">
                    <div class="form-group">
                        <label>Add Note</label>
                        <textarea id="newNote" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                        <button onclick="addNote()" class="btn btn-primary btn-small mt-10">Add Note</button>
                    </div>
                    
                    <div class="history-list mt-10" id="notesHistoryList">
                        <div class="empty-state">
                            <div class="empty-state-text">No notes</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Attempt Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Record Contact Attempt</h2>
                <button class="close-btn" onclick="closeModal('contactModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>Contact Mode</label>
                    <select id="contactMode">
                        <option value="">Select mode...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="contactNotes" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="closeModal('contactModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="saveContact()" class="btn btn-success">Save Contact</button>
            </div>
        </div>
    </div>

    <!-- Assign to Admin Modal -->
    <div id="assignAdminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign to Physician Admin</h2>
                <button class="close-btn" onclick="closeModal('assignAdminModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>Physician Admin</label>
                    <select id="physicianAdmin">
                        <option value="">Select admin...</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="closeModal('assignAdminModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="saveAdminAssignment()" class="btn btn-success">Assign</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/eel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    
    <script>
        // Global state
        let database = null;
        let currentUser = null;
        let isReadOnly = false;
        let unsavedChanges = 0;
        let currentEditingReferral = null;
        let currentViewingReferral = null;
        let autoSaveInterval = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded');
        });

        // Login handling
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                const result = await eel.login(username, password)();
                
                if (result.status === 'success') {
                    currentUser = username;
                    isReadOnly = result.readOnly;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('currentUsername').textContent = username;
                    
                    if (isReadOnly) {
                        document.getElementById('readOnlyBanner').style.display = 'block';
                        disableEditingControls();
                    }
                    
                    await initializeApp();
                } else if (result.status === 'locked') {
                    // Ask user if they want read-only access
                    const readOnlyChoice = confirm(
                        `Database is currently locked by ${result.user}\n\n` +
                        `Click OK to open in Read-Only mode (you can view but not edit).\n` +
                        `Click Cancel to return to login.`
                    );
                    
                    if (readOnlyChoice) {
                        await eel.login_readonly(username)();
                        currentUser = username;
                        isReadOnly = true;
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('currentUsername').textContent = username;
                        document.getElementById('readOnlyBanner').style.display = 'block';
                        document.getElementById('lockOwnerName').textContent = result.user;
                        disableEditingControls();
                        await initializeApp();
                    }
                } else {
                    errorDiv.textContent = result.message || 'Login failed';
                    errorDiv.style.display = 'block';
                    document.getElementById('loginPassword').value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'An error occurred during login';
                errorDiv.style.display = 'block';
            }
        }

        // Logout
        async function logout() {
            if (unsavedChanges > 0) {
                const choice = confirm(`You have ${unsavedChanges} unsaved change(s)!\n\nClick OK to save and logout, or Cancel to logout without saving.`);
                if (choice) {
                    await saveDatabase();
                }
            }
            
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            
            await eel.logout()();
            
            currentUser = null;
            isReadOnly = false;
            unsavedChanges = 0;
            
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('readOnlyBanner').style.display = 'none';
        }

        // Initialize app
        async function initializeApp() {
            // Load database
            const result = await eel.load_database()();
            if (result.status === 'success') {
                database = result.data;
                populateSelectOptions();
                renderReferralList();
                
                // Start auto-save (every 5 minutes)
                if (!isReadOnly) {
                    autoSaveInterval = setInterval(async () => {
                        if (unsavedChanges > 0) {
                            await saveDatabase(true); // silent save
                        }
                    }, 5 * 60 * 1000);
                }
            } else {
                alert('Error loading database: ' + result.message);
            }
        }

        // Populate select options
        function populateSelectOptions() {
            const options = database.selectOptions;
            
            // Referring physicians
            const refPhysSelect = document.getElementById('referringPhysician');
            refPhysSelect.innerHTML = '<option value="">Select physician...</option>';
            options.referringPhysicians.forEach(phys => {
                const opt = document.createElement('option');
                opt.value = phys.name;
                opt.textContent = phys.name;
                opt.dataset.billing = phys.billing;
                opt.dataset.fax = phys.fax;
                opt.dataset.phone = phys.phone;
                opt.dataset.email = phys.email;
                refPhysSelect.appendChild(opt);
            });
            
            // Requested locations
            populateSelect('requestedLocation', options.requestedLocations);
            
            // Requested physicians
            populateSelect('requestedPhysician', options.requestedPhysicians);
            
            // Services
            populateSelect('serviceRequested', options.servicesRequested);
            
            // New/Prev/Partner
            populateSelect('newPrevPartner', options.newPrevPartner);
            
            // Contact modes
            populateSelect('contactMode', options.lastAttemptModes);
            
            // Physician admins
            populateSelect('physicianAdmin', options.physicianAdmins);
            
            // Gender
            populateSelect('patientGender', options.genderAtBirth);
            populateSelect('partnerGender', options.genderAtBirth);
        }

        function populateSelect(id, values) {
            const select = document.getElementById(id);
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select...</option>';
            values.forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                select.appendChild(opt);
            });
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Update physician info when selected
        function updatePhysicianInfo() {
            const select = document.getElementById('referringPhysician');
            const option = select.options[select.selectedIndex];
            
            if (option.value) {
                document.getElementById('billingNumber').value = option.dataset.billing || '';
                document.getElementById('physicianFax').value = option.dataset.fax || '';
                document.getElementById('physicianPhone').value = option.dataset.phone || '';
                document.getElementById('physicianEmail').value = option.dataset.email || '';
            }
        }

        // Disable editing controls in read-only mode
        function disableEditingControls() {
            document.getElementById('saveButton').disabled = true;
            document.getElementById('saveButton').style.opacity = '0.5';
            document.getElementById('addReferralBtn').disabled = true;
            document.getElementById('addReferralBtn').style.opacity = '0.5';
        }

        // Save database
        async function saveDatabase(silent = false) {
            if (isReadOnly) {
                if (!silent) alert('Cannot save in read-only mode');
                return;
            }
            
            const result = await eel.save_database(database)();
            
            if (result.status === 'success') {
                unsavedChanges = 0;
                updateUnsavedIndicator();
                if (!silent) alert('Database saved successfully');
            } else {
                alert('Error saving database: ' + result.message);
            }
        }

        // Update unsaved indicator
        function updateUnsavedIndicator() {
            const indicator = document.getElementById('unsavedIndicator');
            if (unsavedChanges > 0) {
                indicator.style.display = 'inline';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Open add referral modal
        function openAddReferralModal() {
            if (isReadOnly) {
                alert('Cannot add referrals in read-only mode');
                return;
            }
            
            currentEditingReferral = null;
            document.getElementById('referralModalTitle').textContent = 'Add New Referral';
            document.getElementById('referralForm').reset();
            initializeDatePickers();
            openModal('referralModal');
        }

        // Initialize date pickers
        function initializeDatePickers() {
            const datepickers = document.querySelectorAll('.datepicker');
            datepickers.forEach(input => {
                flatpickr(input, {
                    dateFormat: 'Y-m-d',
                    allowInput: true
                });
            });
        }

        // Save referral
        async function saveReferral() {
            if (isReadOnly) {
                alert('Cannot save referrals in read-only mode');
                return;
            }
            
            const referralData = {
                // Referral info
                referralDate: document.getElementById('referralDate').value,
                receivedDate: document.getElementById('receivedDate').value,
                fileName: document.getElementById('fileName').value,
                referringPhysicianName: document.getElementById('referringPhysician').value,
                referringPhysicianBilling: document.getElementById('billingNumber').value,
                referringPhysicianFax: document.getElementById('physicianFax').value,
                referringPhysicianPhone: document.getElementById('physicianPhone').value,
                referringPhysicianEmail: document.getElementById('physicianEmail').value,
                
                // Service info
                requestedLocation: document.getElementById('requestedLocation').value,
                requestedPhysician: document.getElementById('requestedPhysician').value,
                urgent: document.getElementById('urgent').checked,
                serviceRequested: document.getElementById('serviceRequested').value,
                subServiceRequested: document.getElementById('subServiceRequested').value,
                newPrevPartner: document.getElementById('newPrevPartner').value,
                
                // Patient info
                patientPID: document.getElementById('patientPID').value,
                patientMRN: document.getElementById('patientMRN').value,
                patientFirstName: document.getElementById('patientFirstName').value,
                patientMiddleName: document.getElementById('patientMiddleName').value,
                patientLastName: document.getElementById('patientLastName').value,
                patientDOB: document.getElementById('patientDOB').value,
                patientPhone: document.getElementById('patientPhone').value,
                patientEmail: document.getElementById('patientEmail').value,
                patientAddress: document.getElementById('patientAddress').value,
                patientHC: document.getElementById('patientHC').value,
                patientGender: document.getElementById('patientGender').value,
                
                // Partner info
                partnerPID: document.getElementById('partnerPID').value,
                partnerMRN: document.getElementById('partnerMRN').value,
                partnerFirstName: document.getElementById('partnerFirstName').value,
                partnerMiddleName: document.getElementById('partnerMiddleName').value,
                partnerLastName: document.getElementById('partnerLastName').value,
                partnerDOB: document.getElementById('partnerDOB').value,
                partnerPhone: document.getElementById('partnerPhone').value,
                partnerEmail: document.getElementById('partnerEmail').value,
                partnerAddress: document.getElementById('partnerAddress').value,
                partnerHC: document.getElementById('partnerHC').value,
                partnerGender: document.getElementById('partnerGender').value,
                
                // Referral handling (defaults)
                referralStatus: 'New',
                lastAttemptDate: null,
                lastAttemptTime: null,
                lastAttemptMode: null,
                lastAttemptComment: null,
                attemptHistory: [],
                faxedBackDate: null,
                completeInfoReceivedDate: null,
                taskedToPhysicianAdmin: null,
                referralCompleteDate: null,
                notes: null,
                notesDate: null,
                notesHistory: []
            };
            
            let result;
            if (currentEditingReferral) {
                // Update existing
                referralData.id = currentEditingReferral.id;
                referralData.addedToDBDate = currentEditingReferral.addedToDBDate;
                result = await eel.update_referral(currentEditingReferral.id, referralData)();
                
                // Update in local database
                const index = database.referrals.findIndex(r => r.id === currentEditingReferral.id);
                if (index !== -1) {
                    database.referrals[index] = referralData;
                }
            } else {
                // Add new
                result = await eel.add_referral(referralData)();
                if (result.status === 'success') {
                    database.referrals.push(result.referral);
                }
            }
            
            if (result.status === 'success') {
                unsavedChanges = 0; // Backend already saved
                updateUnsavedIndicator();
                renderReferralList();
                closeModal('referralModal');
            } else {
                alert('Error saving referral: ' + result.message);
            }
        }

        // Render referral list
        function renderReferralList() {
            const container = document.getElementById('referralList');
            const referrals = filterAndSortReferrals();
            
            document.getElementById('referralCount').textContent = referrals.length;
            
            if (referrals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No referrals found</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = referrals.map(ref => {
                const patientName = `${ref.patientFirstName || ''} ${ref.patientLastName || ''}`.trim() || 'Unknown Patient';
                const receivedDate = ref.receivedDate ? new Date(ref.receivedDate).toLocaleDateString() : 'N/A';
                const location = ref.requestedLocation || 'N/A';
                const physician = ref.requestedPhysician || 'N/A';
                const lastContact = ref.lastAttemptDate ? 
                    `${new Date(ref.lastAttemptDate).toLocaleDateString()} ${ref.lastAttemptTime || ''}` : 
                    'No contact';
                
                let statusClass = '';
                switch(ref.referralStatus) {
                    case 'New': statusClass = 'status-new'; break;
                    case 'Pending': statusClass = 'status-pending'; break;
                    case 'All Information Received': statusClass = 'status-info-received'; break;
                    case 'Deferred': statusClass = 'status-deferred'; break;
                    case 'Completed': statusClass = 'status-completed'; break;
                }
                
                return `
                    <div class="referral-item" onclick="viewReferral(${ref.id})">
                        <div class="referral-left">
                            <div class="referral-header">
                                <span class="referral-patient-name">${patientName}</span>
                                <span class="referral-id">#${ref.id}</span>
                                <span class="status-badge ${statusClass}">${ref.referralStatus}</span>
                            </div>
                            <div class="referral-info">
                                <span>üìÖ Received: ${receivedDate}</span>
                                <span>üìû ${ref.patientPhone || 'No phone'}</span>
                                <span>üìß ${ref.patientEmail || 'No email'}</span>
                                <span>üìç ${location}</span>
                                <span>üë®‚Äç‚öïÔ∏è ${physician}</span>
                                <span>üí¨ Last contact: ${lastContact}</span>
                            </div>
                        </div>
                        <div class="referral-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-primary btn-small" onclick="editReferralById(${ref.id})">Edit</button>
                            <button class="btn btn-success btn-small" onclick="quickContact(${ref.id})">Contact</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter and sort referrals
        function filterAndSortReferrals() {
            if (!database || !database.referrals) return [];
            
            let referrals = [...database.referrals];
            
            // Apply search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                referrals = referrals.filter(ref => {
                    const patientName = `${ref.patientFirstName || ''} ${ref.patientLastName || ''}`.toLowerCase();
                    const id = ref.id.toString();
                    const phone = (ref.patientPhone || '').toLowerCase();
                    const email = (ref.patientEmail || '').toLowerCase();
                    
                    return patientName.includes(searchTerm) || 
                           id.includes(searchTerm) || 
                           phone.includes(searchTerm) || 
                           email.includes(searchTerm);
                });
            }
            
            // Apply status filter
            const filter = document.getElementById('filterSelect').value;
            if (filter !== 'all') {
                referrals = referrals.filter(ref => {
                    switch(filter) {
                        case 'new': return ref.referralStatus === 'New';
                        case 'pending': return ref.referralStatus === 'Pending';
                        case 'info-received': return ref.referralStatus === 'All Information Received';
                        case 'deferred': return ref.referralStatus === 'Deferred';
                        case 'completed': return ref.referralStatus === 'Completed';
                        case 'missing-contact': return !ref.lastAttemptDate;
                        case 'contact-2days':
                        case 'contact-3days':
                        case 'contact-7days':
                            if (!ref.lastAttemptDate) return false;
                            const days = filter === 'contact-2days' ? 2 : filter === 'contact-3days' ? 3 : 7;
                            const daysSinceContact = (new Date() - new Date(ref.lastAttemptDate)) / (1000 * 60 * 60 * 24);
                            return daysSinceContact > days;
                    }
                    return true;
                });
            }
            
            // Apply sort
            const sortMode = document.getElementById('sortSelect').value;
            referrals.sort((a, b) => {
                switch(sortMode) {
                    case 'name-az':
                        const nameA = `${a.patientFirstName || ''} ${a.patientLastName || ''}`.toLowerCase();
                        const nameB = `${b.patientFirstName || ''} ${b.patientLastName || ''}`.toLowerCase();
                        return nameA.localeCompare(nameB);
                    
                    case 'attempt-old':
                        const dateA = a.lastAttemptDate ? new Date(a.lastAttemptDate) : new Date(0);
                        const dateB = b.lastAttemptDate ? new Date(b.lastAttemptDate) : new Date(0);
                        return dateA - dateB;
                    
                    case 'attempt-new':
                        const dateA2 = a.lastAttemptDate ? new Date(a.lastAttemptDate) : new Date(0);
                        const dateB2 = b.lastAttemptDate ? new Date(b.lastAttemptDate) : new Date(0);
                        return dateB2 - dateA2;
                    
                    case 'received-new':
                        const recA = a.receivedDate ? new Date(a.receivedDate) : new Date(0);
                        const recB = b.receivedDate ? new Date(b.receivedDate) : new Date(0);
                        return recB - recA;
                    
                    case 'received-old':
                        const recA2 = a.receivedDate ? new Date(a.receivedDate) : new Date(0);
                        const recB2 = b.receivedDate ? new Date(b.receivedDate) : new Date(0);
                        return recA2 - recB2;
                }
                return 0;
            });
            
            return referrals;
        }

        // Filter referrals (called by controls)
        function filterReferrals() {
            renderReferralList();
        }

        // View referral details
        function viewReferral(id) {
            const referral = database.referrals.find(r => r.id === id);
            if (!referral) return;
            
            currentViewingReferral = referral;
            
            document.getElementById('viewReferralTitle').textContent = 
                `${referral.patientFirstName || ''} ${referral.patientLastName || ''}`.trim() || 'Unknown Patient';
            
            // Populate details tab
            const detailsHtml = `
                <div class="form-section">
                    <div class="form-section-title">Referral Information</div>
                    <div class="form-row">
                        <div><strong>ID:</strong> #${referral.id}</div>
                        <div><strong>Status:</strong> ${referral.referralStatus}</div>
                    </div>
                    <div class="form-row">
                        <div><strong>Referral Date:</strong> ${referral.referralDate || 'N/A'}</div>
                        <div><strong>Received Date:</strong> ${referral.receivedDate || 'N/A'}</div>
                    </div>
                    <div class="form-row">
                        <div><strong>File Name:</strong> ${referral.fileName || 'N/A'}</div>
                        <div><strong>Urgent:</strong> ${referral.urgent ? 'Yes' : 'No'}</div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Referring Physician</div>
                    <div class="form-row">
                        <div><strong>Name:</strong> ${referral.referringPhysicianName || 'N/A'}</div>
                        <div><strong>Billing:</strong> ${referral.referringPhysicianBilling || 'N/A'}</div>
                    </div>
                    <div class="form-row">
                        <div><strong>Phone:</strong> ${referral.referringPhysicianPhone || 'N/A'}</div>
                        <div><strong>Fax:</strong> ${referral.referringPhysicianFax || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Service Information</div>
                    <div class="form-row">
                        <div><strong>Location:</strong> ${referral.requestedLocation || 'N/A'}</div>
                        <div><strong>Physician:</strong> ${referral.requestedPhysician || 'N/A'}</div>
                    </div>
                    <div class="form-row">
                        <div><strong>Service:</strong> ${referral.serviceRequested || 'N/A'}</div>
                        <div><strong>Sub Service:</strong> ${referral.subServiceRequested || 'N/A'}</div>
                    </div>
                    <div class="form-row">
                        <div><strong>Patient Type:</strong> ${referral.newPrevPartner || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Patient Information</div>
                    <div class="form-row">
                        <div><strong>Name:</strong> ${referral.patientFirstName || ''} ${referral.patientMiddleName || ''} ${referral.patientLastName || ''}</div>
                        <div><strong>DOB:</strong> ${referral.patientDOB || 'N/A'}</div>
                    </div>
                    <div class="form-row">
                        <div><strong>PID:</strong> ${referral.patientPID || 'N/A'}</div>
                        <div><strong>MRN:</strong> ${referral.patientMRN || 'N/A'}</div>
                    </div>
                    <div class="form-row">
                        <div><strong>Phone:</strong> ${referral.patientPhone || 'N/A'}</div>
                        <div><strong>Email:</strong> ${referral.patientEmail || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Partner Information</div>
                    <div class="form-row">
                        <div><strong>Name:</strong> ${referral.partnerFirstName || ''} ${referral.partnerMiddleName || ''} ${referral.partnerLastName || ''}</div>
                        <div><strong>DOB:</strong> ${referral.partnerDOB || 'N/A'}</div>
                    </div>
                    <div class="form-row">
                        <div><strong>Phone:</strong> ${referral.partnerPhone || 'N/A'}</div>
                        <div><strong>Email:</strong> ${referral.partnerEmail || 'N/A'}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('referralDetails').innerHTML = detailsHtml;
            
            // Populate contact history
            renderContactHistory(referral);
            
            // Populate notes
            renderNotesHistory(referral);
            
            // Update button visibility based on status
            updateViewModalButtons(referral);
            
            openModal('viewReferralModal');
        }

        function renderContactHistory(referral) {
            const container = document.getElementById('contactHistoryList');
            
            if (!referral.attemptHistory || referral.attemptHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-text">No contact history</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = referral.attemptHistory.map(attempt => `
                <div class="history-item">
                    <div class="history-date">${attempt.date} ${attempt.time || ''} - ${attempt.mode}</div>
                    <div class="history-content">${attempt.comment || 'No notes'}</div>
                </div>
            `).join('');
        }

        function renderNotesHistory(referral) {
            const container = document.getElementById('notesHistoryList');
            
            if (!referral.notesHistory || referral.notesHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-text">No notes</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = referral.notesHistory.map(note => `
                <div class="history-item">
                    <div class="history-date">${note.date}</div>
                    <div class="history-content">${note.note}</div>
                </div>
            `).join('');
        }

        function updateViewModalButtons(referral) {
            // Show/hide buttons based on status and read-only mode
            const editBtn = document.getElementById('editReferralBtn');
            const contactBtn = document.getElementById('contactBtn');
            const infoReceivedBtn = document.getElementById('infoReceivedBtn');
            const assignAdminBtn = document.getElementById('assignAdminBtn');
            
            if (isReadOnly) {
                editBtn.style.display = 'none';
                contactBtn.style.display = 'none';
                infoReceivedBtn.style.display = 'none';
                assignAdminBtn.style.display = 'none';
                return;
            }
            
            editBtn.style.display = 'inline-block';
            contactBtn.style.display = 'inline-block';
            
            if (referral.referralStatus === 'Pending') {
                infoReceivedBtn.style.display = 'inline-block';
            } else {
                infoReceivedBtn.style.display = 'none';
            }
            
            if (referral.referralStatus === 'All Information Received') {
                assignAdminBtn.style.display = 'inline-block';
            } else {
                assignAdminBtn.style.display = 'none';
            }
        }

        // Edit referral
        function editReferral() {
            if (isReadOnly) {
                alert('Cannot edit in read-only mode');
                return;
            }
            
            closeModal('viewReferralModal');
            editReferralById(currentViewingReferral.id);
        }

        function editReferralById(id) {
            if (isReadOnly) {
                alert('Cannot edit in read-only mode');
                return;
            }
            
            const referral = database.referrals.find(r => r.id === id);
            if (!referral) return;
            
            currentEditingReferral = referral;
            document.getElementById('referralModalTitle').textContent = 'Edit Referral';
            
            // Populate form
            document.getElementById('referralDate').value = referral.referralDate || '';
            document.getElementById('receivedDate').value = referral.receivedDate || '';
            document.getElementById('fileName').value = referral.fileName || '';
            document.getElementById('referringPhysician').value = referral.referringPhysicianName || '';
            document.getElementById('billingNumber').value = referral.referringPhysicianBilling || '';
            document.getElementById('physicianFax').value = referral.referringPhysicianFax || '';
            document.getElementById('physicianPhone').value = referral.referringPhysicianPhone || '';
            document.getElementById('physicianEmail').value = referral.referringPhysicianEmail || '';
            
            document.getElementById('requestedLocation').value = referral.requestedLocation || '';
            document.getElementById('requestedPhysician').value = referral.requestedPhysician || '';
            document.getElementById('urgent').checked = referral.urgent || false;
            document.getElementById('serviceRequested').value = referral.serviceRequested || '';
            document.getElementById('subServiceRequested').value = referral.subServiceRequested || '';
            document.getElementById('newPrevPartner').value = referral.newPrevPartner || '';
            
            document.getElementById('patientPID').value = referral.patientPID || '';
            document.getElementById('patientMRN').value = referral.patientMRN || '';
            document.getElementById('patientFirstName').value = referral.patientFirstName || '';
            document.getElementById('patientMiddleName').value = referral.patientMiddleName || '';
            document.getElementById('patientLastName').value = referral.patientLastName || '';
            document.getElementById('patientDOB').value = referral.patientDOB || '';
            document.getElementById('patientPhone').value = referral.patientPhone || '';
            document.getElementById('patientEmail').value = referral.patientEmail || '';
            document.getElementById('patientAddress').value = referral.patientAddress || '';
            document.getElementById('patientHC').value = referral.patientHC || '';
            document.getElementById('patientGender').value = referral.patientGender || '';
            
            document.getElementById('partnerPID').value = referral.partnerPID || '';
            document.getElementById('partnerMRN').value = referral.partnerMRN || '';
            document.getElementById('partnerFirstName').value = referral.partnerFirstName || '';
            document.getElementById('partnerMiddleName').value = referral.partnerMiddleName || '';
            document.getElementById('partnerLastName').value = referral.partnerLastName || '';
            document.getElementById('partnerDOB').value = referral.partnerDOB || '';
            document.getElementById('partnerPhone').value = referral.partnerPhone || '';
            document.getElementById('partnerEmail').value = referral.partnerEmail || '';
            document.getElementById('partnerAddress').value = referral.partnerAddress || '';
            document.getElementById('partnerHC').value = referral.partnerHC || '';
            document.getElementById('partnerGender').value = referral.partnerGender || '';
            
            initializeDatePickers();
            openModal('referralModal');
        }

        // Quick contact from list
        function quickContact(id) {
            const referral = database.referrals.find(r => r.id === id);
            if (!referral) return;
            
            currentViewingReferral = referral;
            openContactModal();
        }

        // Open contact modal
        function openContactModal() {
            if (isReadOnly) {
                alert('Cannot add contact attempts in read-only mode');
                return;
            }
            
            document.getElementById('contactMode').value = '';
            document.getElementById('contactNotes').value = '';
            openModal('contactModal');
        }

        // Save contact attempt
        async function saveContact() {
            const mode = document.getElementById('contactMode').value;
            const notes = document.getElementById('contactNotes').value;
            
            if (!mode) {
                alert('Please select a contact mode');
                return;
            }
            
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0];
            
            currentViewingReferral.lastAttemptDate = date;
            currentViewingReferral.lastAttemptTime = time;
            currentViewingReferral.lastAttemptMode = mode;
            currentViewingReferral.lastAttemptComment = notes;
            
            if (!currentViewingReferral.attemptHistory) {
                currentViewingReferral.attemptHistory = [];
            }
            
            currentViewingReferral.attemptHistory.push({
                date: date,
                time: time,
                mode: mode,
                comment: notes
            });
            
            // Change status from New to Pending if it's New
            if (currentViewingReferral.referralStatus === 'New') {
                currentViewingReferral.referralStatus = 'Pending';
            }
            
            const result = await eel.update_referral(currentViewingReferral.id, currentViewingReferral)();
            
            if (result.status === 'success') {
                unsavedChanges = 0;
                updateUnsavedIndicator();
                renderReferralList();
                closeModal('contactModal');
                
                // Refresh view modal if open
                if (document.getElementById('viewReferralModal').classList.contains('active')) {
                    renderContactHistory(currentViewingReferral);
                    updateViewModalButtons(currentViewingReferral);
                }
            } else {
                alert('Error saving contact: ' + result.message);
            }
        }

        // Mark info received
        async function markInfoReceived() {
            if (isReadOnly) {
                alert('Cannot update status in read-only mode');
                return;
            }
            
            currentViewingReferral.referralStatus = 'All Information Received';
            currentViewingReferral.completeInfoReceivedDate = new Date().toISOString().split('T')[0];
            
            const result = await eel.update_referral(currentViewingReferral.id, currentViewingReferral)();
            
            if (result.status === 'success') {
                unsavedChanges = 0;
                updateUnsavedIndicator();
                renderReferralList();
                updateViewModalButtons(currentViewingReferral);
            } else {
                alert('Error updating status: ' + result.message);
            }
        }

        // Open assign admin modal
        function openAssignAdminModal() {
            if (isReadOnly) {
                alert('Cannot assign in read-only mode');
                return;
            }
            
            document.getElementById('physicianAdmin').value = '';
            openModal('assignAdminModal');
        }

        // Save admin assignment
        async function saveAdminAssignment() {
            const admin = document.getElementById('physicianAdmin').value;
            
            if (!admin) {
                alert('Please select a physician admin');
                return;
            }
            
            currentViewingReferral.taskedToPhysicianAdmin = admin;
            currentViewingReferral.referralStatus = 'Completed';
            currentViewingReferral.referralCompleteDate = new Date().toISOString().split('T')[0];
            
            const result = await eel.update_referral(currentViewingReferral.id, currentViewingReferral)();
            
            if (result.status === 'success') {
                unsavedChanges = 0;
                updateUnsavedIndicator();
                renderReferralList();
                closeModal('assignAdminModal');
                updateViewModalButtons(currentViewingReferral);
            } else {
                alert('Error assigning admin: ' + result.message);
            }
        }

        // Add note
        async function addNote() {
            const noteText = document.getElementById('newNote').value;
            
            if (!noteText) {
                alert('Please enter a note');
                return;
            }
            
            if (!currentViewingReferral.notesHistory) {
                currentViewingReferral.notesHistory = [];
            }
            
            currentViewingReferral.notesHistory.push({
                date: new Date().toISOString().split('T')[0],
                note: noteText
            });
            
            currentViewingReferral.notes = noteText;
            currentViewingReferral.notesDate = new Date().toISOString().split('T')[0];
            
            const result = await eel.update_referral(currentViewingReferral.id, currentViewingReferral)();
            
            if (result.status === 'success') {
                unsavedChanges = 0;
                updateUnsavedIndicator();
                document.getElementById('newNote').value = '';
                renderNotesHistory(currentViewingReferral);
            } else {
                alert('Error adding note: ' + result.message);
            }
        }

        // Email patient
        function emailPatient() {
            const email = currentViewingReferral.patientEmail;
            if (email) {
                window.location.href = `mailto:${email}`;
            } else {
                alert('No email address available for this patient');
            }
        }

        // Fax physician
        async function faxPhysician() {
            if (isReadOnly) {
                alert('Cannot update in read-only mode');
                return;
            }
            
            currentViewingReferral.faxedBackDate = new Date().toISOString().split('T')[0];
            
            const result = await eel.update_referral(currentViewingReferral.id, currentViewingReferral)();
            
            if (result.status === 'success') {
                unsavedChanges = 0;
                updateUnsavedIndicator();
                alert('Faxed back date recorded. Please send fax manually.');
            } else {
                alert('Error recording fax: ' + result.message);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Remove active from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active to selected
            event.target.classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
        }

        // Modal helpers
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
    </script>
</body>
</html>
