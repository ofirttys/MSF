<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSF Referrals Management Dashboard</title>
    
    <!-- Flatpickr CSS for date pickers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f3ebff; color: #2c3e50; line-height: 1.6; }

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        /* Login Screen Styles */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: block;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 0px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            color: #2c3e50;
			font-size: 12px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .error-message {
            background: #ffe6e6;
            color: #c0392b;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        /* Header Styles */
        header { 
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header-content { 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
        }
        
        .header-left .logo-container { 
            margin-right: 15px; 
            width: 48px;
            height: 48px;
        }
        
        .header-left h1 { 
            color: #2c3e50; 
            font-size: 24px; 
            font-weight: 600; 
            margin: 0; 
        }

        .header-center {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filters { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        
        .filter-group label { 
            font-size: 14px; 
            color: #666; 
            font-weight: 500; 
        }
        
        .date-input { 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px; 
            width: 130px; 
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Status Bar */
        .status-bar { 
            background: white; 
            padding: 8px 15px; 
            border-radius: 6px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        
        .status-text { 
            font-size: 13px; 
            color: #666; 
        }

        /* KPI Cards */
        .kpi-summary { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        
        .kpi-card { 
            flex: 1; 
            min-width: 140px; 
            background: white; 
            padding: 15px 10px; 
            border-radius: 10px; 
            border-left: 4px solid #9b59b6; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); 
            transition: all 0.3s ease; 
            text-align: center; 
        }
        
        .kpi-card:nth-child(1) { border-color: #9b59b6; }
        .kpi-card:nth-child(2) { border-color: #3498db; }
        .kpi-card:nth-child(3) { border-color: #e74c3c; }
        .kpi-card:nth-child(4) { border-color: #f39c12; }
        .kpi-card:nth-child(5) { border-color: #27ae60; }
        .kpi-card:nth-child(6) { border-color: #95a5a6; }
        
        .kpi-card:nth-child(1) .kpi-label,
        .kpi-card:nth-child(1) .kpi-value { color: #9b59b6; }
        
        .kpi-card:nth-child(2) .kpi-label,
        .kpi-card:nth-child(2) .kpi-value { color: #3498db; }
        
        .kpi-card:nth-child(3) .kpi-label,
        .kpi-card:nth-child(3) .kpi-value { color: #e74c3c; }
        
        .kpi-card:nth-child(4) .kpi-label,
        .kpi-card:nth-child(4) .kpi-value { color: #f39c12; }
        
        .kpi-card:nth-child(5) .kpi-label,
        .kpi-card:nth-child(5) .kpi-value { color: #27ae60; }
        
        .kpi-card:nth-child(6) .kpi-label,
        .kpi-card:nth-child(6) .kpi-value { color: #95a5a6; }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
        }
        
        .kpi-label { 
            font-size: 12px; 
            font-weight: 500; 
            margin-bottom: 8px; 
        }
        
        .kpi-value { 
            font-size: 28px; 
            font-weight: 700; 
        }

        /* Main Card */
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
            border: 1px solid rgba(147, 112, 219, 0.15);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* Filter & Sort Buttons (from HTA) */
        .filter-buttons {
            display: flex;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 4px 8px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            margin-right: 3px;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .filter-btn:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .sort-btn {
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .sort-btn:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .sort-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* Search Box */
        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 18px;
            font-size: 14px;
        }

        .search-box:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Referral List */
        .referral-list {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .referral-item {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .referral-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .referral-left {
            flex: 1;
            min-width: 0;
        }

        .referral-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .referral-patient-name {
            font-weight: 600;
            font-size: 14px;
        }

        .referral-id {
            color: #7f8c8d;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-new {
            background: #e74c3c;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .status-info-received {
            background: #3498db;
            color: white;
        }

        .status-deferred {
            background: #95a5a6;
            color: white;
        }

        .status-completed {
            background: #27ae60;
            color: white;
        }

        .referral-info {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            gap: 15px;
            margin-top: 3px;
            flex-wrap: wrap;
        }

        .referral-actions {
            display: flex;
            gap: 5px;
        }

        /* Footer */
        .footer { 
            text-align: center; 
            padding: 5px; 
            color: #95a5a6; 
            font-size: 12px; 
            margin-top: 20px; 
        }
        
        .footer .copyright { 
            margin-top: 5px; 
            font-size: 11px; 
            color: #b0b0b0; 
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content.large {
            max-width: 1000px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

		.modal-body {
			margin-bottom: 15px;
		}

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #95a5a6;
        }

        .close-btn:hover {
            color: #7f8c8d;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .form-section-title {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* History List */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .history-date {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
        }

        .history-content {
            font-size: 13px;
            color: #2c3e50;
            margin-top: 3px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* Read-only Banner */
        #readOnlyBanner {
            display: none;
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        /* Utility */
        .text-muted { color: #7f8c8d; }
        .text-danger { color: #e74c3c; }
        .text-success { color: #27ae60; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .header-center { justify-content: center; margin: 10px 0; }
            .filters { flex-direction: column; width: 100%; }
            .kpi-summary { flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <script type="text/javascript" src="/eel.js"></script>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <svg class="login-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 550 550"><path fill="#25ABE2" d="M17.1205 215.804C15.2512 213.98 3.89954 203.277 3.13166 201.696C3.96746 200.496 24.4409 195.072 28.0857 194.008L91.6641 175.791C93.3297 177.763 96.1202 183.18 97.646 185.723L98.7692 187.74L119.526 223.648C122.105 228.114 127.284 236.4 129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C81.9393 277.931 77.2785 273.737 73.1017 269.721L48.3392 245.87C40.9193 238.772 31.7108 229.121 24.1798 222.583C21.8072 220.223 19.5985 218.055 17.1205 215.804Z"/><path fill="#DC2C29" d="M129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C87.1982 281.299 95.6147 272.942 97.4191 271.243C108.068 261.219 118.524 250.489 129.305 240.615Z"/><path fill="#25ABE2" d="M369.669 96.1737C390.971 89.8571 412.76 83.9982 434.135 77.819C445.726 74.4681 458.042 70.5393 469.736 67.8083C469.149 70.0459 468.652 72.4249 468.142 74.6904L467.243 78.0757L454.223 129.716C451.905 139.071 449.754 148.715 447.126 157.969C442.855 157.616 437.793 157.734 433.433 157.734L412.978 157.735L389.211 157.747C384.728 157.751 379.386 157.63 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525L360.624 98.78C363.462 98.0718 366.819 97.005 369.669 96.1737Z"/><path fill="#DC2C29" d="M360.524 98.6525L360.624 98.78C360.761 101.314 362.888 108.581 363.542 111.429C366.043 122.318 369.125 133.191 371.703 144.072C372.763 148.543 374.155 153.453 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525Z"/><path fill="#25ABE2" d="M104.112 386.16C111.597 386.015 119.966 386.213 127.545 386.213L176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C187.521 445.778 182.293 447.477 179.194 448.359L155.893 455.087L94.4803 472.686C90.2246 473.945 85.7043 475.096 81.4007 476.217C82.8134 470.922 83.9962 465.165 85.3475 459.788L98.104 408.939C99.2889 404.23 102.39 389.669 104.112 386.16Z"/><path fill="#DC2C29" d="M176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C190.428 443.052 187.171 430.895 186.441 428.062L180.18 403.006C178.829 397.617 177.118 391.586 176.054 386.187Z"/><path fill="#25ABE2" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477L378.039 434.64L370.03 467.376C368.589 472.632 367.186 477.946 365.947 483.253C363.145 495.261 359.871 507.142 356.999 519.129L354.179 530.761L354.102 531.004C353.529 532.862 353.031 536.843 351.899 537.871C351.266 537.814 351.415 537.849 350.796 537.658C349.588 535.643 338.013 525.074 335.621 522.779L299.149 487.61L296.613 485.188C293.114 482.08 289.776 478.469 286.105 475.225C293.923 460.334 303.253 445.792 311.441 431.071C313.892 426.665 316.587 421.702 319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#DC2C29" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477C373.436 432.869 366.713 431.253 361.94 429.855L319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#25ABE2" d="M198.84 5.58799C204.614 10.4081 209.89 15.8699 215.324 21.098L241.962 46.7938L254.143 58.482C256.254 60.5282 262.475 66.7839 264.51 68.2112C264.663 69.1602 264.801 69.0228 264.298 69.9266C262.266 73.5786 260.092 77.2522 257.997 80.8644L245.789 101.968L236.682 117.729C235.28 120.161 233.184 124.266 231.516 126.413C228.522 125.2 219.738 122.888 216.37 121.921L186.351 113.342C183.252 112.462 175.686 110.555 172.99 109.411C176.973 92.0214 181.67 74.6125 185.906 57.2838L193.505 27.0218C195.233 20.0162 196.854 12.4681 198.84 5.58799Z"/><path fill="#FDAF19" d="M101.486 88.8467C104.016 89.7253 106.587 90.3149 109.161 91.0514L123.884 95.2716L153.812 103.814C159.099 105.305 167.755 107.541 172.725 109.411L172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C123.926 157.895 120.533 157.757 118.581 158.138C118.16 156.994 117.376 153.144 117.061 151.778C116.101 147.618 115.155 143.529 114.107 139.381L101.486 88.8467Z"/><path fill="#DC2C29" d="M172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C129.058 157.544 135.273 157.693 138.467 157.69L161.179 157.701C162.04 152.138 173.361 111.269 172.725 109.411L172.99 109.411Z"/><path fill="#FDAF19" d="M85.9258 282.128C89.0077 284.428 93.9369 289.446 96.8382 292.254L114.218 309.054C115.981 310.766 119.96 314.857 121.739 316.272C119.502 320.512 117.024 324.518 114.625 328.653C114.074 329.602 111.899 333.24 111.599 334.097C110.539 335.775 108.955 338.453 108.051 340.281C107.367 341.236 107.098 341.664 106.565 342.709C104.882 345.583 103.066 348.554 101.579 351.521C100.777 352.772 100.042 354.689 98.9702 355.118C97.2535 354.208 89.1585 351.975 86.9382 351.321L52.0742 341.324L48.3624 340.312C42.521 338.72 36.7055 336.957 30.9004 335.232C32.7025 333.091 35.2179 330.575 37.2664 328.618C51.3496 315.166 65.162 301.379 79.4367 288.137C81.4919 286.231 83.7705 283.805 85.9258 282.128Z"/><path fill="#FDAF19" d="M390.536 386.207L418.33 386.207C422.11 386.2 428.82 385.982 432.35 386.263C433.135 388.921 433.822 391.439 434.519 394.117L436.412 401.952C438.238 409.88 440.271 417.772 442.356 425.637C442.7 426.935 442.989 428.258 443.416 429.531C443.599 430.626 443.739 431.377 444.031 432.445C445.09 437.198 447.728 449.194 449.352 453.407L449.596 454.382L449.427 454.716C448.083 455.162 437.772 451.723 435.814 451.174L397.876 440.419C393.818 439.287 389.181 437.707 385.189 436.736C382.921 435.868 380.399 435.266 378.039 434.64L377.944 434.477C379.211 430.103 380.379 424.5 381.498 419.991L389.317 388.58C389.699 387.064 389.522 386.822 390.536 386.207Z"/><path fill="#FDAF19" d="M293.645 81.5672C298.241 76.1306 304.384 71.4223 309.44 66.4096C315.677 60.6778 321.485 53.6435 327.918 48.188C333.325 43.6033 338.534 37.6884 343.95 33.4048C345.173 36.1096 347.095 44.1829 347.945 47.4432C348.075 47.96 348.552 50.0487 348.748 50.3843C348.955 51.4388 349.154 52.5725 349.395 53.6123C351.202 61.3387 353.199 69.0207 355.209 76.6973C355.589 78.146 355.942 79.7492 356.408 81.1647C357.326 86.4982 359.215 93.2727 360.524 98.6525C357.689 100.939 318.472 110.484 311.753 113.078C308.598 108.386 304.958 101.422 301.966 96.3799C299.734 92.6201 295.381 85.3541 293.645 81.5672Z"/><path fill="#FDAF19" d="M239.269 430.708L251.532 451.853C252.541 453.594 255.965 459.808 257.046 461.148C257.174 461.927 257.392 462.136 256.9 462.644C254.487 465.134 251.695 467.75 249.206 470.143L229.338 489.284C227.751 490.811 221.269 496.808 220.147 498.213C219.197 499.097 215.312 502.681 214.766 503.471C213.474 504.616 207.762 510.415 206.84 510.59C205.616 507.49 203.56 497.663 202.619 493.859L193.885 459.067C193.577 457.622 193.287 456.451 192.893 455.026C192.582 453.586 192.4 452.615 191.863 451.223C191.612 449.548 190.978 447.102 190.591 445.393C190.699 445.235 190.808 445.077 190.916 444.919C204.77 440.608 219.228 436.842 233.099 432.704C236.705 431.628 237.355 431.701 239.269 430.708Z"/><path fill="#25ABE2" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C468.441 265.221 474.007 270.912 477.403 273.671C487.898 284.224 499.362 294.866 510.098 305.223C521.591 316.309 533.226 327.867 544.865 338.759C545.611 339.475 547.258 341.187 548.082 341.586L548.31 342.415C547.799 343.112 546.929 343.148 545.918 343.443L542.434 344.438L504.138 355.382C502.972 355.687 501.468 356.027 500.364 356.428C499.101 356.683 497.879 357.007 496.651 357.393C486.574 360.566 476.253 363.13 466.161 366.204C464.258 366.783 461.069 367.834 459.222 368.14C454.784 360.817 450.302 352.778 446.001 345.334L421.784 303.437L403.624 272.104Z"/><path fill="#DC2C29" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C462.097 264.164 454.938 271.664 451.919 274.492C441.848 283.922 431.941 294.133 421.784 303.437L403.624 272.104Z"/><path fill="#FDAF19" d="M451.487 189.086C455.312 190.444 462.169 192.077 466.53 193.38C484.248 198.676 502.576 203.39 520.258 208.744C518.42 210.635 516.561 212.437 514.67 214.272C511.351 217.055 506.557 222.008 503.291 225.183L465.133 261.937C462.623 260.08 456.016 253.452 453.494 251.027L429.28 227.577C435.69 216.108 442.389 204.801 448.895 193.387C449.724 191.932 450.597 190.504 451.487 189.086Z"/></svg>
                <h1>MSF Referrals Management</h1>
                <p>Please login to continue</p>
            </div>
            
            <div id="loginError" class="error-message"></div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <!-- Read-Only Banner -->
            <div id="readOnlyBanner">
                üîí READ-ONLY MODE - Database is being edited by <span id="lockOwnerName"></span>
            </div>

            <!-- Header -->
            <header>
                <div class="header-content">
                    <div class="header-left">
                        <div class="logo-container">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 550 550"><path fill="#25ABE2" d="M17.1205 215.804C15.2512 213.98 3.89954 203.277 3.13166 201.696C3.96746 200.496 24.4409 195.072 28.0857 194.008L91.6641 175.791C93.3297 177.763 96.1202 183.18 97.646 185.723L98.7692 187.74L119.526 223.648C122.105 228.114 127.284 236.4 129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C81.9393 277.931 77.2785 273.737 73.1017 269.721L48.3392 245.87C40.9193 238.772 31.7108 229.121 24.1798 222.583C21.8072 220.223 19.5985 218.055 17.1205 215.804Z"/><path fill="#DC2C29" d="M129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C87.1982 281.299 95.6147 272.942 97.4191 271.243C108.068 261.219 118.524 250.489 129.305 240.615Z"/><path fill="#25ABE2" d="M369.669 96.1737C390.971 89.8571 412.76 83.9982 434.135 77.819C445.726 74.4681 458.042 70.5393 469.736 67.8083C469.149 70.0459 468.652 72.4249 468.142 74.6904L467.243 78.0757L454.223 129.716C451.905 139.071 449.754 148.715 447.126 157.969C442.855 157.616 437.793 157.734 433.433 157.734L412.978 157.735L389.211 157.747C384.728 157.751 379.386 157.63 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525L360.624 98.78C363.462 98.0718 366.819 97.005 369.669 96.1737Z"/><path fill="#DC2C29" d="M360.524 98.6525L360.624 98.78C360.761 101.314 362.888 108.581 363.542 111.429C366.043 122.318 369.125 133.191 371.703 144.072C372.763 148.543 374.155 153.453 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525Z"/><path fill="#25ABE2" d="M104.112 386.16C111.597 386.015 119.966 386.213 127.545 386.213L176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C187.521 445.778 182.293 447.477 179.194 448.359L155.893 455.087L94.4803 472.686C90.2246 473.945 85.7043 475.096 81.4007 476.217C82.8134 470.922 83.9962 465.165 85.3475 459.788L98.104 408.939C99.2889 404.23 102.39 389.669 104.112 386.16Z"/><path fill="#DC2C29" d="M176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C190.428 443.052 187.171 430.895 186.441 428.062L180.18 403.006C178.829 397.617 177.118 391.586 176.054 386.187Z"/><path fill="#25ABE2" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477L378.039 434.64L370.03 467.376C368.589 472.632 367.186 477.946 365.947 483.253C363.145 495.261 359.871 507.142 356.999 519.129L354.179 530.761L354.102 531.004C353.529 532.862 353.031 536.843 351.899 537.871C351.266 537.814 351.415 537.849 350.796 537.658C349.588 535.643 338.013 525.074 335.621 522.779L299.149 487.61L296.613 485.188C293.114 482.08 289.776 478.469 286.105 475.225C293.923 460.334 303.253 445.792 311.441 431.071C313.892 426.665 316.587 421.702 319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#DC2C29" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477C373.436 432.869 366.713 431.253 361.94 429.855L319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#25ABE2" d="M198.84 5.58799C204.614 10.4081 209.89 15.8699 215.324 21.098L241.962 46.7938L254.143 58.482C256.254 60.5282 262.475 66.7839 264.51 68.2112C264.663 69.1602 264.801 69.0228 264.298 69.9266C262.266 73.5786 260.092 77.2522 257.997 80.8644L245.789 101.968L236.682 117.729C235.28 120.161 233.184 124.266 231.516 126.413C228.522 125.2 219.738 122.888 216.37 121.921L186.351 113.342C183.252 112.462 175.686 110.555 172.99 109.411C176.973 92.0214 181.67 74.6125 185.906 57.2838L193.505 27.0218C195.233 20.0162 196.854 12.4681 198.84 5.58799Z"/><path fill="#FDAF19" d="M101.486 88.8467C104.016 89.7253 106.587 90.3149 109.161 91.0514L123.884 95.2716L153.812 103.814C159.099 105.305 167.755 107.541 172.725 109.411L172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C123.926 157.895 120.533 157.757 118.581 158.138C118.16 156.994 117.376 153.144 117.061 151.778C116.101 147.618 115.155 143.529 114.107 139.381L101.486 88.8467Z"/><path fill="#DC2C29" d="M172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C129.058 157.544 135.273 157.693 138.467 157.69L161.179 157.701C162.04 152.138 173.361 111.269 172.725 109.411L172.99 109.411Z"/><path fill="#FDAF19" d="M85.9258 282.128C89.0077 284.428 93.9369 289.446 96.8382 292.254L114.218 309.054C115.981 310.766 119.96 314.857 121.739 316.272C119.502 320.512 117.024 324.518 114.625 328.653C114.074 329.602 111.899 333.24 111.599 334.097C110.539 335.775 108.955 338.453 108.051 340.281C107.367 341.236 107.098 341.664 106.565 342.709C104.882 345.583 103.066 348.554 101.579 351.521C100.777 352.772 100.042 354.689 98.9702 355.118C97.2535 354.208 89.1585 351.975 86.9382 351.321L52.0742 341.324L48.3624 340.312C42.521 338.72 36.7055 336.957 30.9004 335.232C32.7025 333.091 35.2179 330.575 37.2664 328.618C51.3496 315.166 65.162 301.379 79.4367 288.137C81.4919 286.231 83.7705 283.805 85.9258 282.128Z"/><path fill="#FDAF19" d="M390.536 386.207L418.33 386.207C422.11 386.2 428.82 385.982 432.35 386.263C433.135 388.921 433.822 391.439 434.519 394.117L436.412 401.952C438.238 409.88 440.271 417.772 442.356 425.637C442.7 426.935 442.989 428.258 443.416 429.531C443.599 430.626 443.739 431.377 444.031 432.445C445.09 437.198 447.728 449.194 449.352 453.407L449.596 454.382L449.427 454.716C448.083 455.162 437.772 451.723 435.814 451.174L397.876 440.419C393.818 439.287 389.181 437.707 385.189 436.736C382.921 435.868 380.399 435.266 378.039 434.64L377.944 434.477C379.211 430.103 380.379 424.5 381.498 419.991L389.317 388.58C389.699 387.064 389.522 386.822 390.536 386.207Z"/><path fill="#FDAF19" d="M293.645 81.5672C298.241 76.1306 304.384 71.4223 309.44 66.4096C315.677 60.6778 321.485 53.6435 327.918 48.188C333.325 43.6033 338.534 37.6884 343.95 33.4048C345.173 36.1096 347.095 44.1829 347.945 47.4432C348.075 47.96 348.552 50.0487 348.748 50.3843C348.955 51.4388 349.154 52.5725 349.395 53.6123C351.202 61.3387 353.199 69.0207 355.209 76.6973C355.589 78.146 355.942 79.7492 356.408 81.1647C357.326 86.4982 359.215 93.2727 360.524 98.6525C357.689 100.939 318.472 110.484 311.753 113.078C308.598 108.386 304.958 101.422 301.966 96.3799C299.734 92.6201 295.381 85.3541 293.645 81.5672Z"/><path fill="#FDAF19" d="M239.269 430.708L251.532 451.853C252.541 453.594 255.965 459.808 257.046 461.148C257.174 461.927 257.392 462.136 256.9 462.644C254.487 465.134 251.695 467.75 249.206 470.143L229.338 489.284C227.751 490.811 221.269 496.808 220.147 498.213C219.197 499.097 215.312 502.681 214.766 503.471C213.474 504.616 207.762 510.415 206.84 510.59C205.616 507.49 203.56 497.663 202.619 493.859L193.885 459.067C193.577 457.622 193.287 456.451 192.893 455.026C192.582 453.586 192.4 452.615 191.863 451.223C191.612 449.548 190.978 447.102 190.591 445.393C190.699 445.235 190.808 445.077 190.916 444.919C204.77 440.608 219.228 436.842 233.099 432.704C236.705 431.628 237.355 431.701 239.269 430.708Z"/><path fill="#25ABE2" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C468.441 265.221 474.007 270.912 477.403 273.671C487.898 284.224 499.362 294.866 510.098 305.223C521.591 316.309 533.226 327.867 544.865 338.759C545.611 339.475 547.258 341.187 548.082 341.586L548.31 342.415C547.799 343.112 546.929 343.148 545.918 343.443L542.434 344.438L504.138 355.382C502.972 355.687 501.468 356.027 500.364 356.428C499.101 356.683 497.879 357.007 496.651 357.393C486.574 360.566 476.253 363.13 466.161 366.204C464.258 366.783 461.069 367.834 459.222 368.14C454.784 360.817 450.302 352.778 446.001 345.334L421.784 303.437L403.624 272.104Z"/><path fill="#DC2C29" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C462.097 264.164 454.938 271.664 451.919 274.492C441.848 283.922 431.941 294.133 421.784 303.437L403.624 272.104Z"/><path fill="#FDAF19" d="M451.487 189.086C455.312 190.444 462.169 192.077 466.53 193.38C484.248 198.676 502.576 203.39 520.258 208.744C518.42 210.635 516.561 212.437 514.67 214.272C511.351 217.055 506.557 222.008 503.291 225.183L465.133 261.937C462.623 260.08 456.016 253.452 453.494 251.027L429.28 227.577C435.69 216.108 442.389 204.801 448.895 193.387C449.724 191.932 450.597 190.504 451.487 189.086Z"/></svg>
                        </div>
                        <h1>MSF Referrals Management</h1>
                    </div>
                    <div class="header-center">
                        <button onclick="openAddReferralModal()" class="btn btn-primary" id="addReferralBtn">+ Add Referral</button>
                        <button onclick="saveDatabase()" class="btn btn-success" id="saveButton">Save</button>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>From:</label>
                            <input type="text" class="date-input" id="dateFrom" placeholder="Start">
                        </div>
                        <div class="filter-group">
                            <label>To:</label>
                            <input type="text" class="date-input" id="dateTo" placeholder="End">
                        </div>
                        <button class="btn btn-success" onclick="resetFilters()">Reset</button>
                        <button onclick="logout()" class="btn btn-secondary">Logout</button>
                    </div>
                </div>
            </header>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-text" id="statusBar">
                    <strong>Database: <span id="currentFile">No file loaded</span></strong>
                </div>
            </div>

            <!-- KPI Summary -->
            <div class="kpi-summary">
                <div class="kpi-card">
                    <div class="kpi-label">Total Referrals</div>
                    <div class="kpi-value" id="kpiTotal">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">New Patients</div>
                    <div class="kpi-value" id="kpiNew">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Waiting for Contact</div>
                    <div class="kpi-value" id="kpiWaitingContact">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Pending</div>
                    <div class="kpi-value" id="kpiPending">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Completed</div>
                    <div class="kpi-value" id="kpiCompleted">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Deferred</div>
                    <div class="kpi-value" id="kpiDeferred">-</div>
                </div>
            </div>

            <!-- Referrals List Card -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="card-title" style="margin-bottom: 0;">All Referrals (<span id="referralCount">0</span>)</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="sort-btn active" id="sortNameAZ" onclick="setSortMode('name-az')">Name A‚ÜíZ</button>
                        <button class="sort-btn" id="sortAttemptOld" onclick="setSortMode('attempt-old')">Last Attempt (Old‚ÜíNew)</button>
                        <button class="sort-btn" id="sortAttemptNew" onclick="setSortMode('attempt-new')">Last Attempt (New‚ÜíOld)</button>
                        <button class="sort-btn" id="sortReceivedOld" onclick="setSortMode('received-old')">Received (Old‚ÜíNew)</button>
                        <button class="sort-btn" id="sortReceivedNew" onclick="setSortMode('received-new')">Received (New‚ÜíOld)</button>
                    </div>
                </div>
                <div class="filter-buttons" id="filterButtons">
                    <button class="filter-btn active" onclick="filterByStatus('all')">All</button>
                    <button class="filter-btn" onclick="filterByStatus('new')">New<br>Patient</button>
                    <button class="filter-btn" onclick="filterByStatus('pending')">Pending</button>
                    <button class="filter-btn" onclick="filterByStatus('info-received')">Info<br>Received</button>
                    <button class="filter-btn" onclick="filterByStatus('completed')">Completed</button>
                    <button class="filter-btn" onclick="filterByStatus('deferred')">Deferred</button>
                    <button class="filter-btn" onclick="filterByStatus('missing-contact')">Waiting<br>Contact</button>
                    <button class="filter-btn" onclick="filterByStatus('contact-2days')">Contact<br>> 2 days</button>
                    <button class="filter-btn" onclick="filterByStatus('contact-3days')">Contact<br>> 3 days</button>
                    <button class="filter-btn" onclick="filterByStatus('contact-7days')">Contact<br>> 7 days</button>
                </div>
                <input type="text" class="search-box" id="searchBox" placeholder="Search referrals..." oninput="filterReferrals()">
                <div class="referral-list" id="referralList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No referrals found</div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div>MSF Referrals Management Dashboard</div>
                <div class="copyright">&copy; Dr. Jennia Michaeli | Mount Sinai Fertility</div>
            </footer>
        </div>

		<!-- Add/Edit Referral Modal -->
		<div id="referralModal" class="modal">
			<div class="modal-content large">
				<div class="modal-header">
					<h2 class="modal-title" id="referralModalTitle">Add New Referral</h2>
					<button class="close-btn" onclick="closeModal('referralModal')">&times;</button>
				</div>
				
				<div class="modal-body">
					<form id="referralForm">
						<!-- Referral Information -->
						<div class="form-section">
							<div class="form-section-title">Referral Information</div>
							
							<div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
								<div class="form-group">
									<label>Referral Date</label>
									<input type="text" id="referralDate" class="datepicker">
								</div>
								<div class="form-group">
									<label>Received Date</label>
									<input type="text" id="receivedDate" class="datepicker">
								</div>
								<div class="form-group">
									<label>File Name</label>
									<input type="file" id="fileNamePicker" onchange="updateFileName()" accept=".pdf,.doc,.docx,.jpg,.png">
									<input type="text" id="fileName" readonly style="margin-top: 5px; background: #f0f0f0;">
								</div>
							</div>
							
							<div class="form-row" style="grid-template-columns: 2fr 1fr 1fr;">
								<div class="form-group">
									<label>Referring Physician Name</label>
									<input type="text" id="referringPhysician">
								</div>
								<div class="form-group">
									<label>Billing Number</label>
									<input type="text" id="billingNumber">
								</div>
								<div class="form-group">
									<label>Fax</label>
									<input type="text" id="physicianFax">
								</div>
							</div>
							
							<div class="form-row">
								<div class="form-group">
									<label>Phone</label>
									<input type="text" id="physicianPhone">
								</div>
								<div class="form-group">
									<label>Email</label>
									<input type="email" id="physicianEmail">
								</div>
							</div>
						</div>

						<!-- Service Information -->
						<div class="form-section">
							<div class="form-section-title">Service Information</div>
							
							<div class="form-row full">
								<div class="form-group checkbox-group" style="justify-content: flex-start;">
									<input type="checkbox" id="urgent">
									<label for="urgent" style="color: #e74c3c; font-weight: 600; font-size: 14px;">‚ö†Ô∏è URGENT</label>
								</div>
							</div>
							
							<div class="form-row">
								<div class="form-group">
									<label>Requested Location</label>
									<select id="requestedLocation">
										<option value="">Select location...</option>
									</select>
								</div>
								<div class="form-group">
									<label>Requested Physician</label>
									<select id="requestedPhysician">
										<option value="">Select physician...</option>
									</select>
								</div>
							</div>
							
							<div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
								<div class="form-group">
									<label>Referral Type</label>
									<select id="referralType">
										<option value="">Select...</option>
									</select>
								</div>
								<div class="form-group">
									<label>Service Requested</label>
									<select id="serviceRequested">
										<option value="">Select service...</option>
									</select>
								</div>
								<div class="form-group">
									<label>Sub Service Requested</label>
									<input type="text" id="subServiceRequested">
								</div>
							</div>
						</div>

						<!-- Patient and Partner Information -->
						<div class="form-section">
							<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
								<div class="form-section-title" style="margin-bottom: 0;">Patient and Partner Information</div>
								<div class="checkbox-group">
									<input type="checkbox" id="enablePartner" onchange="togglePartnerFields()">
									<label for="enablePartner">Include Partner</label>
								</div>
							</div>
							
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
								<!-- Patient Column -->
								<div>
									<div style="font-weight: 600; margin-bottom: 10px; color: #667eea;">Patient</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>PID</label>
											<input type="text" id="patientPID">
										</div>
										<div class="form-group">
											<label>MRN</label>
											<input type="text" id="patientMRN">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>First Name</label>
											<input type="text" id="patientFirstName">
										</div>
										<div class="form-group">
											<label>Last Name</label>
											<input type="text" id="patientLastName">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Middle Name</label>
											<input type="text" id="patientMiddleName">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Date of Birth</label>
											<input type="text" id="patientDOB" class="datepicker">
										</div>
										<div class="form-group">
											<label>Gender at Birth</label>
											<select id="patientGenderAtBirth">
												<option value="">Select...</option>
											</select>
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Phone</label>
											<input type="tel" id="patientPhone">
										</div>
										<div class="form-group">
											<label>Email</label>
											<input type="email" id="patientEmail">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Address</label>
											<input type="text" id="patientAddress">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Health Card</label>
											<input type="text" id="patientHC">
										</div>
									</div>
								</div>
								
								<!-- Partner Column -->
								<div id="partnerSection" style="opacity: 0.4; pointer-events: none;">
									<div style="font-weight: 600; margin-bottom: 10px; color: #95a5a6;">Partner</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>PID</label>
											<input type="text" id="partnerPID">
										</div>
										<div class="form-group">
											<label>MRN</label>
											<input type="text" id="partnerMRN">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>First Name</label>
											<input type="text" id="partnerFirstName">
										</div>
										<div class="form-group">
											<label>Last Name</label>
											<input type="text" id="partnerLastName">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Middle Name</label>
											<input type="text" id="partnerMiddleName">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Date of Birth</label>
											<input type="text" id="partnerDOB" class="datepicker">
										</div>
										<div class="form-group">
											<label>Gender at Birth</label>
											<select id="partnerGenderAtBirth">
												<option value="">Select...</option>
											</select>
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Phone</label>
											<input type="tel" id="partnerPhone">
										</div>
										<div class="form-group">
											<label>Email</label>
											<input type="email" id="partnerEmail">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Address</label>
											<input type="text" id="partnerAddress">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Health Card</label>
											<input type="text" id="partnerHC">
										</div>
									</div>
								</div>
							</div>
						</div>
				
				<div class="modal-footer">
					<button onclick="closeModal('referralModal')" class="btn btn-secondary">Cancel</button>
					<button onclick="saveReferral()" class="btn btn-success" id="saveReferralBtn">Save Referral</button>
				</div>
			</div>
		</div>
    </div>

    <!-- Modals will go here - keeping from previous version -->
    <!-- (Add/Edit Referral Modal, View Referral Modal, Contact Modal, Assign Admin Modal) -->
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    
    <script>
        // Global state
        let database = null;
        let currentUser = null;
        let isReadOnly = false;
        let unsavedChanges = 0;
        let currentEditingReferral = null;
        let currentViewingReferral = null;
        let autoSaveInterval = null;
        let currentSortMode = 'name-az';
        let currentFilter = 'all';

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MSF Referrals Management loaded');
        });

        // Login handling
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                const result = await eel.login(username, password)();
                
                if (result.status === 'success') {
                    currentUser = username;
                    isReadOnly = result.readOnly;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    if (isReadOnly) {
                        document.getElementById('readOnlyBanner').style.display = 'block';
                        disableEditingControls();
                    }
                    
                    await initializeApp();
                } else if (result.status === 'locked') {
                    const readOnlyChoice = confirm(
                        `Database is currently locked by ${result.user}\n\n` +
                        `Click OK to open in Read-Only mode (you can view but not edit).\n` +
                        `Click Cancel to return to login.`
                    );
                    
                    if (readOnlyChoice) {
                        await eel.login_readonly(username)();
                        currentUser = username;
                        isReadOnly = true;
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('readOnlyBanner').style.display = 'block';
                        document.getElementById('lockOwnerName').textContent = result.user;
                        disableEditingControls();
                        await initializeApp();
                    }
                } else {
                    errorDiv.textContent = result.message || 'Login failed';
                    errorDiv.style.display = 'block';
                    document.getElementById('loginPassword').value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'An error occurred during login';
                errorDiv.style.display = 'block';
            }
        }

        // Logout
        async function logout() {
            if (unsavedChanges > 0) {
                const choice = confirm(`You have ${unsavedChanges} unsaved change(s)!\n\nClick OK to save and logout, or Cancel to logout without saving.`);
                if (choice) {
                    await saveDatabase();
                }
            }
            
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            
            await eel.logout()();
            
            currentUser = null;
            isReadOnly = false;
            unsavedChanges = 0;
            
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('readOnlyBanner').style.display = 'none';
        }

        // Initialize app
        async function initializeApp() {
            const result = await eel.load_database()();
            if (result.status === 'success') {
                database = result.data;
                document.getElementById('currentFile').textContent = 'DB\\referrals.json';
                populateSelectOptions();
				renderReferralList();
                updateKPIs();
                
				// Initialize date pickers
				flatpickr('#dateFrom', {
					dateFormat: 'Y-m-d',
					allowInput: true,
					onChange: function() { filterReferrals(); }
				});
				flatpickr('#dateTo', {
					dateFormat: 'Y-m-d',
					allowInput: true,
					onChange: function() { filterReferrals(); }
				});				
				
                if (!isReadOnly) {
                    autoSaveInterval = setInterval(async () => {
                        if (unsavedChanges > 0) {
                            await saveDatabase(true);
                        }
                    }, 5 * 60 * 1000);
                }
            } else {
				document.getElementById('currentFile').textContent = 'Error: ' + result.message;
				document.getElementById('statusBar').style.color = '#e74c3c';
			}
        }

		// Initialize date pickers (add after initializeApp function)
		flatpickr('#dateFrom', {
			dateFormat: 'Y-m-d',
			allowInput: true,
			onChange: function() {
				filterReferrals();
			}
		});

		flatpickr('#dateTo', {
			dateFormat: 'Y-m-d',
			allowInput: true,
			onChange: function() {
				filterReferrals();
			}
		});

        // Disable editing controls in read-only mode
        function disableEditingControls() {
            document.getElementById('saveButton').disabled = true;
            document.getElementById('saveButton').style.opacity = '0.5';
            document.getElementById('addReferralBtn').disabled = true;
            document.getElementById('addReferralBtn').style.opacity = '0.5';
        }

        // Save database
		async function saveDatabase(silent = false) {
			if (isReadOnly) {
				if (!silent) {
					document.getElementById('currentFile').textContent = 'Error: Cannot save in read-only mode';
					document.getElementById('statusBar').style.color = '#e74c3c';
				}
				return;
			}
			
			const result = await eel.save_database(database)();
			
			if (result.status === 'success') {
				unsavedChanges = 0;
				if (!silent) {
					document.getElementById('currentFile').textContent = 'DB\\referrals.json - Saved successfully';
					document.getElementById('statusBar').style.color = '#27ae60';
					// Reset color after 3 seconds
					setTimeout(() => {
						document.getElementById('currentFile').textContent = 'DB\\referrals.json';
						document.getElementById('statusBar').style.color = '#666';
					}, 3000);
				}
			} else {
				document.getElementById('currentFile').textContent = 'Save Error: ' + result.message;
				document.getElementById('statusBar').style.color = '#e74c3c';
			}
		}

        // Update KPIs
        function updateKPIs() {
            if (!database || !database.referrals) return;
            
            const refs = database.referrals;
            const now = new Date();
            const twoDaysAgo = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000));
            
            document.getElementById('kpiTotal').textContent = refs.length;
            document.getElementById('kpiNew').textContent = refs.filter(r => r.referralType === 'New').length;
            document.getElementById('kpiPending').textContent = refs.filter(r => r.referralStatus === 'Pending').length;
            document.getElementById('kpiCompleted').textContent = refs.filter(r => r.referralStatus === 'Completed').length;
            document.getElementById('kpiDeferred').textContent = refs.filter(r => r.referralStatus === 'Deferred').length;
            
            // Waiting for contact: New OR Pending AND (no lastAttemptDate OR lastAttemptDate > 2 days ago)
            const waitingContact = refs.filter(r => {
                if (r.referralStatus !== 'New' && r.referralStatus !== 'Pending') return false;
                if (!r.lastAttemptDate) return true;
                const lastAttempt = new Date(r.lastAttemptDate);
                return lastAttempt < twoDaysAgo;
            }).length;
            document.getElementById('kpiWaitingContact').textContent = waitingContact;
        }

        // Render referral list
        function renderReferralList() {
            const container = document.getElementById('referralList');
            const referrals = filterAndSortReferrals();
            
            document.getElementById('referralCount').textContent = referrals.length;
            
            if (referrals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No referrals found</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = referrals.map(ref => {
                const patientName = `${ref.patientFirstName || ''} ${ref.patientLastName || ''}`.trim() || 'Unknown Patient';
                const receivedDate = ref.receivedDate ? new Date(ref.receivedDate).toLocaleDateString() : 'N/A';
                const location = ref.requestedLocation || 'N/A';
                const physician = ref.requestedPhysician || 'N/A';
                const lastContact = ref.lastAttemptDate ? 
                    `${new Date(ref.lastAttemptDate).toLocaleDateString()} ${ref.lastAttemptTime || ''}` : 
                    'No contact';
                
                let statusClass = '';
                switch(ref.referralStatus) {
                    case 'New': statusClass = 'status-new'; break;
                    case 'Pending': statusClass = 'status-pending'; break;
                    case 'Info Received': statusClass = 'status-info-received'; break;
                    case 'Deferred': statusClass = 'status-deferred'; break;
                    case 'Completed': statusClass = 'status-completed'; break;
                }
                
                return `
					<div class="referral-item" onclick="viewReferral(${ref.referralID})">
						<div class="referral-left">
							<div class="referral-header">
								<span class="referral-patient-name">${patientName}</span>
								<span class="status-badge ${statusClass}">${ref.referralStatus}</span>
							</div>
							<div class="referral-info">
								<span>üìÖ ${receivedDate}</span>
								<span>üìû ${ref.patientPhone || 'No phone'}</span>
								<span>üìß ${ref.patientEmail || 'No email'}</span>
								<span>üìç ${location}</span>
								<span>üë®‚Äç‚öïÔ∏è ${physician}</span>
								<span>üí¨ ${lastContact}</span>
							</div>
						</div>
						<div class="referral-actions" onclick="event.stopPropagation()">
							<button class="btn btn-primary btn-small" onclick="editReferralById(${ref.referralID})">Edit</button>
							<button class="btn btn-success btn-small" onclick="quickContact(${ref.referralID})">Contact</button>
						</div>
					</div>
                `;
            }).join('');
        }

        // Filter and sort referrals
        function filterAndSortReferrals() {
            if (!database || !database.referrals) return [];
            
            let referrals = [...database.referrals];
            
            // Apply search filter
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (searchTerm) {
                referrals = referrals.filter(ref => {
                    const patientName = `${ref.patientFirstName || ''} ${ref.patientLastName || ''}`.toLowerCase();
                    const id = ref.referralID.toString();
                    const phone = (ref.patientPhone || '').toLowerCase();
                    const email = (ref.patientEmail || '').toLowerCase();
                    
                    return patientName.includes(searchTerm) || 
                           id.includes(searchTerm) || 
                           phone.includes(searchTerm) || 
                           email.includes(searchTerm);
                });
            }
            
            // Apply status filter
            if (currentFilter !== 'all') {
                const now = new Date();
                referrals = referrals.filter(ref => {
                    switch(currentFilter) {
                        case 'new': return ref.referralStatus === 'New';
                        case 'pending': return ref.referralStatus === 'Pending';
                        case 'info-received': return ref.referralStatus === 'Info Received';
                        case 'deferred': return ref.referralStatus === 'Deferred';
                        case 'completed': return ref.referralStatus === 'Completed';
                        case 'missing-contact': return !ref.lastAttemptDate;
                        case 'contact-2days':
                        case 'contact-3days':
                        case 'contact-7days':
                            if (!ref.lastAttemptDate) return false;
                            const days = currentFilter === 'contact-2days' ? 2 : currentFilter === 'contact-3days' ? 3 : 7;
                            const daysSinceContact = (now - new Date(ref.lastAttemptDate)) / (1000 * 60 * 60 * 24);
                            return daysSinceContact > days;
                    }
                    return true;
                });
            }
            
            // Apply sort
            referrals.sort((a, b) => {
                switch(currentSortMode) {
                    case 'name-az':
                        const nameA = `${a.patientFirstName || ''} ${a.patientLastName || ''}`.toLowerCase();
                        const nameB = `${b.patientFirstName || ''} ${b.patientLastName || ''}`.toLowerCase();
                        return nameA.localeCompare(nameB);
                    
                    case 'attempt-old':
                        const dateA = a.lastAttemptDate ? new Date(a.lastAttemptDate) : new Date(0);
                        const dateB = b.lastAttemptDate ? new Date(b.lastAttemptDate) : new Date(0);
                        return dateA - dateB;
                    
                    case 'attempt-new':
                        const dateA2 = a.lastAttemptDate ? new Date(a.lastAttemptDate) : new Date(0);
                        const dateB2 = b.lastAttemptDate ? new Date(b.lastAttemptDate) : new Date(0);
                        return dateB2 - dateA2;
                    
                    case 'received-new':
                        const recA = a.receivedDate ? new Date(a.receivedDate) : new Date(0);
                        const recB = b.receivedDate ? new Date(b.receivedDate) : new Date(0);
                        return recB - recA;
                    
                    case 'received-old':
                        const recA2 = a.receivedDate ? new Date(a.receivedDate) : new Date(0);
                        const recB2 = b.receivedDate ? new Date(b.receivedDate) : new Date(0);
                        return recA2 - recB2;
                }
                return 0;
            });
            
            return referrals;
        }

        // Set sort mode
        function setSortMode(mode) {
            currentSortMode = mode;
            
            // Update button states
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            const btnId = {
                'name-az': 'sortNameAZ',
                'attempt-old': 'sortAttemptOld',
                'attempt-new': 'sortAttemptNew',
                'received-new': 'sortReceivedNew',
                'received-old': 'sortReceivedOld'
            }[mode];
            if (btnId) document.getElementById(btnId).classList.add('active');
            
            renderReferralList();
        }

        // Filter by status
        function filterByStatus(status) {
            currentFilter = status;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderReferralList();
        }

        // Filter referrals (called by search input)
        function filterReferrals() {
            renderReferralList();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            currentFilter = 'all';
            currentSortMode = 'name-az';
            document.getElementById('searchBox').value = '';
            
            // Reset button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.filter-btn').classList.add('active');
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('sortNameAZ').classList.add('active');
            
            renderReferralList();
        }

		function openAddReferralModal() {
			if (isReadOnly) {
				document.getElementById('currentFile').textContent = 'Error: Cannot add referrals in read-only mode';
				document.getElementById('statusBar').style.color = '#e74c3c';
				return;
			}
			
			// Will implement the modal below
			openModal('referralModal');
		}

        function viewReferral(id) {
            alert('View referral #' + id + ' - coming soon');
        }

		function editReferralById(id) {
			if (isReadOnly) {
				document.getElementById('currentFile').textContent = 'Error: Cannot edit in read-only mode';
				document.getElementById('statusBar').style.color = '#e74c3c';
				return;
			}
			
			const referral = database.referrals.find(r => r.referralID === id);
			if (!referral) return;
			
			currentEditingReferral = referral;
			document.getElementById('referralModalTitle').textContent = 'Edit Referral';
			
			// Populate all fields
			document.getElementById('referralDate').value = referral.referralDate || '';
			document.getElementById('receivedDate').value = referral.receivedDate || '';
			document.getElementById('fileName').value = referral.fileName || '';
			document.getElementById('referringPhysician').value = referral.referringPhysicianName || '';
			document.getElementById('billingNumber').value = referral.referringPhysicianBilling || '';
			document.getElementById('physicianFax').value = referral.referringPhysicianFax || '';
			document.getElementById('physicianPhone').value = referral.referringPhysicianPhone || '';
			document.getElementById('physicianEmail').value = referral.referringPhysicianEmail || '';
			
			document.getElementById('requestedLocation').value = referral.requestedLocation || '';
			document.getElementById('requestedPhysician').value = referral.requestedPhysician || '';
			document.getElementById('urgent').checked = referral.urgent || false;
			document.getElementById('serviceRequested').value = referral.serviceRequested || '';
			document.getElementById('subServiceRequested').value = referral.subServiceRequested || '';
			document.getElementById('referralType').value = referral.referralType || '';
			
			document.getElementById('patientPID').value = referral.patientPID || '';
			document.getElementById('patientMRN').value = referral.patientMRN || '';
			document.getElementById('patientFirstName').value = referral.patientFirstName || '';
			document.getElementById('patientMiddleName').value = referral.patientMiddleName || '';
			document.getElementById('patientLastName').value = referral.patientLastName || '';
			document.getElementById('patientDOB').value = referral.patientDOB || '';
			document.getElementById('patientPhone').value = referral.patientPhone || '';
			document.getElementById('patientEmail').value = referral.patientEmail || '';
			document.getElementById('patientAddress').value = referral.patientAddress || '';
			document.getElementById('patientHC').value = referral.patientHC || '';
			document.getElementById('patientGenderAtBirth').value = referral.patientGenderAtBirth || '';
			
			// Partner fields
			const hasPartner = referral.partnerFirstName || referral.partnerLastName;
			document.getElementById('enablePartner').checked = hasPartner;
			togglePartnerFields();
			
			document.getElementById('partnerPID').value = referral.partnerPID || '';
			document.getElementById('partnerMRN').value = referral.partnerMRN || '';
			document.getElementById('partnerFirstName').value = referral.partnerFirstName || '';
			document.getElementById('partnerMiddleName').value = referral.partnerMiddleName || '';
			document.getElementById('partnerLastName').value = referral.partnerLastName || '';
			document.getElementById('partnerDOB').value = referral.partnerDOB || '';
			document.getElementById('partnerPhone').value = referral.partnerPhone || '';
			document.getElementById('partnerEmail').value = referral.partnerEmail || '';
			document.getElementById('partnerAddress').value = referral.partnerAddress || '';
			document.getElementById('partnerHC').value = referral.partnerHC || '';
			document.getElementById('partnerGenderAtBirth').value = referral.partnerGenderAtBirth || '';
			
			initializeDatePickers();
			openModal('referralModal');
		}

        function quickContact(id) {
            alert('Quick contact for referral #' + id + ' - coming soon');
        }
		
		// Modal helpers
		function openModal(id) {
			document.getElementById(id).classList.add('active');
		}

		function closeModal(id) {
			document.getElementById(id).classList.remove('active');
		}

		// Populate select options in modal
		function populateSelectOptions() {
			if (!database || !database.selectOptions) return;
			
			const options = database.selectOptions;
			
			// Requested locations
			populateSelect('requestedLocation', options.requestedLocations);
			
			// Requested physicians
			populateSelect('requestedPhysician', options.requestedPhysicians);
			
			// Services
			populateSelect('serviceRequested', options.servicesRequested);
			
			// Referral Type
			populateSelect('referralType', options.referralType);
			
			// Gender
			populateSelect('patientGenderAtBirth', options.genderAtBirth);
			populateSelect('partnerGenderAtBirth', options.genderAtBirth);
		}

		function populateSelect(id, values) {
			const select = document.getElementById(id);
			const currentValue = select.value;
			const firstOption = select.options[0].outerHTML; // Keep first option
			select.innerHTML = firstOption;
			values.forEach(val => {
				const opt = document.createElement('option');
				opt.value = val;
				opt.textContent = val;
				select.appendChild(opt);
			});
			if (currentValue) {
				select.value = currentValue;
			}
		}

		// Initialize date pickers in modal
		function initializeDatePickers() {
			const datepickers = document.querySelectorAll('.datepicker');
			datepickers.forEach(input => {
				flatpickr(input, {
					dateFormat: 'Y-m-d',
					allowInput: true
				});
			});
		}

		// Save referral
		async function saveReferral() {
			if (isReadOnly) {
				document.getElementById('currentFile').textContent = 'Error: Cannot save in read-only mode';
				document.getElementById('statusBar').style.color = '#e74c3c';
				return;
			}
			
			// Collect form data
			const referralData = {
				// Referral info
				referralDate: document.getElementById('referralDate').value,
				receivedDate: document.getElementById('receivedDate').value,
				fileName: document.getElementById('fileName').value,
				referringPhysicianName: document.getElementById('referringPhysician').value,
				referringPhysicianBilling: document.getElementById('billingNumber').value,
				referringPhysicianFax: document.getElementById('physicianFax').value,
				referringPhysicianPhone: document.getElementById('physicianPhone').value,
				referringPhysicianEmail: document.getElementById('physicianEmail').value,
				
				// Service info
				requestedLocation: document.getElementById('requestedLocation').value,
				requestedPhysician: document.getElementById('requestedPhysician').value,
				urgent: document.getElementById('urgent').checked,
				serviceRequested: document.getElementById('serviceRequested').value,
				subServiceRequested: document.getElementById('subServiceRequested').value,
				referralType: document.getElementById('referralType').value,
				
				// Patient info
				patientPID: document.getElementById('patientPID').value,
				patientMRN: document.getElementById('patientMRN').value,
				patientFirstName: document.getElementById('patientFirstName').value,
				patientMiddleName: document.getElementById('patientMiddleName').value,
				patientLastName: document.getElementById('patientLastName').value,
				patientDOB: document.getElementById('patientDOB').value,
				patientPhone: document.getElementById('patientPhone').value,
				patientEmail: document.getElementById('patientEmail').value,
				patientAddress: document.getElementById('patientAddress').value,
				patientHC: document.getElementById('patientHC').value,
				patientGenderAtBirth: document.getElementById('patientGenderAtBirth').value,
				
				// Partner info
				partnerPID: document.getElementById('partnerPID').value,
				partnerMRN: document.getElementById('partnerMRN').value,
				partnerFirstName: document.getElementById('partnerFirstName').value,
				partnerMiddleName: document.getElementById('partnerMiddleName').value,
				partnerLastName: document.getElementById('partnerLastName').value,
				partnerDOB: document.getElementById('partnerDOB').value,
				partnerPhone: document.getElementById('partnerPhone').value,
				partnerEmail: document.getElementById('partnerEmail').value,
				partnerAddress: document.getElementById('partnerAddress').value,
				partnerHC: document.getElementById('partnerHC').value,
				partnerGenderAtBirth: document.getElementById('partnerGenderAtBirth').value,
				
				// Referral handling (defaults for new referrals)
				referralStatus: 'New',
				lastAttemptDate: null,
				lastAttemptTime: null,
				lastAttemptMode: null,
				lastAttemptComment: null,
				attemptHistory: [],
				faxedBackDate: null,
				completeInfoReceivedDate: null,
				taskedToPhysicianAdmin: null,
				referralCompleteDate: null,
				notes: null,
				notesDate: null,
				notesHistory: []
			};
			
			let result;
			if (currentEditingReferral) {
				// Update existing
				referralData.referralID = currentEditingReferral.referralID;
				referralData.addedToDBDate = currentEditingReferral.addedToDBDate;
				result = await eel.update_referral(currentEditingReferral.referralID, referralData)();
				
				// Update in local database
				const index = database.referrals.findIndex(r => r.referralID === currentEditingReferral.referralID);
				if (index !== -1) {
					database.referrals[index] = referralData;
				}
			} else {
				// Add new
				result = await eel.add_referral(referralData)();
				if (result.status === 'success') {
					database.referrals.push(result.referral);
				}
			}
			
			if (result.status === 'success') {
				unsavedChanges = 0;
				renderReferralList();
				updateKPIs();
				closeModal('referralModal');
				document.getElementById('currentFile').textContent = 'DB\\referrals.json - Referral saved';
				document.getElementById('statusBar').style.color = '#27ae60';
				setTimeout(() => {
					document.getElementById('currentFile').textContent = 'DB\\referrals.json';
					document.getElementById('statusBar').style.color = '#666';
				}, 3000);
			} else {
				document.getElementById('currentFile').textContent = 'Error: ' + result.message;
				document.getElementById('statusBar').style.color = '#e74c3c';
			}
		}		
		
		// Reset and open add referral modal  
		function openAddReferralModal() {
			if (isReadOnly) {
				document.getElementById('currentFile').textContent = 'Error: Cannot add referrals in read-only mode';
				document.getElementById('statusBar').style.color = '#e74c3c';
				return;
			}
			
			currentEditingReferral = null;
			document.getElementById('referralModalTitle').textContent = 'Add New Referral';
			document.getElementById('referralForm').reset();
			initializeDatePickers();
			openModal('referralModal');
		}
		
		function updateFileName() {
			const fileInput = document.getElementById('fileNamePicker');
			const fileName = document.getElementById('fileName');
			if (fileInput.files.length > 0) {
				fileName.value = fileInput.files[0].name;
			}
		}

		function togglePartnerFields() {
			const enabled = document.getElementById('enablePartner').checked;
			const partnerSection = document.getElementById('partnerSection');
			
			if (enabled) {
				partnerSection.style.opacity = '1';
				partnerSection.style.pointerEvents = 'auto';
			} else {
				partnerSection.style.opacity = '0.4';
				partnerSection.style.pointerEvents = 'none';
				// Clear partner fields
				document.querySelectorAll('#partnerSection input, #partnerSection select').forEach(field => {
					field.value = '';
				});
			}
		}

    </script>
</body>
</html>
