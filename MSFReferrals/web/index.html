<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSF Referrals Management Dashboard</title>
    
    <!-- Flatpickr CSS for date pickers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f3ebff; color: #2c3e50; line-height: 1.6; }

		/* When both modals are open, position them side by side */
		body.dual-modal #referralModal {
			justify-content: flex-start;
			padding-left: 2%;
			background: rgba(0,0,0,0.3);
		}

		body.dual-modal #referralModal .modal-content {
			max-width: 50%;
		}

		body.dual-modal #pdfViewerModal .modal-content {
			position: fixed;
			right: 2%;
			top: 5%;
			max-width: 48%;
			margin: 0;
		}

		/* Ensure both modals are visible */
		body.dual-modal .modal.active {
			display: flex;
		}

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        /* Login Screen Styles */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: block;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            color: #2c3e50;
			font-size: 12px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

		.form-group label.required::after {
			content: " *";
			color: #e74c3c;
		}

		#loginForm button {
			width: 100%;
			display: block;
			margin-top: 10px;
		}

        .error-message {
            background: #ffe6e6;
            color: #c0392b;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        /* Header Styles */
        header { 
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header-content { 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
        }
        
        .header-left .logo-container { 
            margin-right: 15px; 
            width: 48px;
            height: 48px;
        }
        
        .header-left h1 { 
            color: #2c3e50; 
            font-size: 24px; 
            font-weight: 600; 
            margin: 0; 
        }

        .header-center {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filters { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        
        .filter-group label { 
            font-size: 14px; 
            color: #666; 
            font-weight: 500; 
        }
        
        .date-input { 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px; 
            width: 130px; 
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Status Bar */
        .status-bar { 
            background: white; 
            padding: 8px 15px; 
            border-radius: 6px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        
        .status-text { 
            font-size: 13px; 
            color: #666; 
        }

        /* KPI Cards */
        .kpi-summary { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        
        .kpi-card { 
            flex: 1; 
            min-width: 140px; 
            background: white; 
            padding: 15px 10px; 
            border-radius: 10px; 
            border-left: 4px solid #9b59b6; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); 
            transition: all 0.3s ease; 
            text-align: center; 
        }
        
        .kpi-card:nth-child(1) { border-color: #9b59b6; }
        .kpi-card:nth-child(2) { border-color: #3498db; }
        .kpi-card:nth-child(3) { border-color: #e74c3c; }
        .kpi-card:nth-child(4) { border-color: #f39c12; }
        .kpi-card:nth-child(5) { border-color: #27ae60; }
        .kpi-card:nth-child(6) { border-color: #95a5a6; }
        
        .kpi-card:nth-child(1) .kpi-label,
        .kpi-card:nth-child(1) .kpi-value { color: #9b59b6; }
        
        .kpi-card:nth-child(2) .kpi-label,
        .kpi-card:nth-child(2) .kpi-value { color: #3498db; }
        
        .kpi-card:nth-child(3) .kpi-label,
        .kpi-card:nth-child(3) .kpi-value { color: #e74c3c; }
        
        .kpi-card:nth-child(4) .kpi-label,
        .kpi-card:nth-child(4) .kpi-value { color: #f39c12; }
        
        .kpi-card:nth-child(5) .kpi-label,
        .kpi-card:nth-child(5) .kpi-value { color: #27ae60; }
        
        .kpi-card:nth-child(6) .kpi-label,
        .kpi-card:nth-child(6) .kpi-value { color: #95a5a6; }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
        }
        
        .kpi-label { 
            font-size: 12px; 
            font-weight: 500; 
            margin-bottom: 8px; 
        }
        
        .kpi-value { 
            font-size: 28px; 
            font-weight: 700; 
        }

        /* Main Card */
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
            border: 1px solid rgba(147, 112, 219, 0.15);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* Filter & Sort Buttons (from HTA) */
        .filter-buttons {
            display: flex;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 4px 8px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            margin-right: 3px;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .filter-btn:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .sort-btn {
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .sort-btn:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .sort-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* Search Box */
        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 18px;
            font-size: 14px;
        }

        .search-box:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Referral List */
        .referral-list {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Grid header row (column labels) */
        .referrals-grid-header {
            display: grid;
            grid-template-columns: 28px 28px 180px 100px 70px 80px 50px 90px 110px 90px 110px 110px 80px 90px 90px;
            gap: 5px;
            padding: 6px 10px;
            background: #ecf0f1;
            border-radius: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 11px;
            margin-bottom: 6px;
        }

        /* Main referral item - Grid layout */
        .referral-item {
            display: grid;
            grid-template-columns: 28px 28px 180px 100px 70px 80px 50px 90px 110px 90px 110px 110px 80px 90px 90px;
            gap: 5px;
            align-items: center;
            padding: 6px 10px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .referral-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        /* Limit visible rows */
        .referral-list {
            max-height: calc(7 * 44px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Individual column styles */
        .ref-urgent {
            font-size: 16px;
            text-align: center;
        }

        .ref-file {
            font-size: 14px;
            text-align: center;
            cursor: pointer;
        }

        .ref-name {
            font-weight: 600;
            color: #2c3e50;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        .ref-status {
            /* Status badge styling below */
        }

        .ref-type {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        .ref-type.type-new {
            background: transparent;
            border: 1px solid #3498db;
            color: #3498db;
        }

        .ref-type.type-previous {
            background: transparent;
            border: 1px solid #1abc9c;
            color: #1abc9c;
        }

        .ref-type.type-partner {
            background: transparent;
            border: 1px solid #f39c12;
            color: #f39c12;
        }

        .ref-dob {
            color: #7f8c8d;
            font-size: 11px;
        }

        .ref-age {
            color: #7f8c8d;
            font-size: 11px;
            text-align: left;
        }

        .ref-age.red {
            color: #e74c3c;
            font-weight: 600;
        }

        .ref-date {
            color: #7f8c8d;
            font-size: 11px;
        }

        .ref-contact {
            color: #7f8c8d;
            font-size: 11px;
        }

        .ref-contact-count {
            color: #7f8c8d;
            font-size: 11px;
            white-space: nowrap;
        }

        .ref-phone {
            color: #34495e;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ref-email {
            color: #34495e;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ref-service {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: transparent;
            border: 1px solid #95a5a6;
            color: #95a5a6;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ref-physician {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ref-physician.phys-first-available {
            background: transparent;
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        .ref-physician.phys-michaeli {
            background: transparent;
            border: 1px solid #9b59b6;
            color: #9b59b6;
        }

        .ref-physician.phys-russo {
            background: transparent;
            border: 1px solid #3498db;
            color: #3498db;
        }

        .ref-physician.phys-pereira {
            background: transparent;
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }

        .ref-physician.phys-jones {
            background: transparent;
            border: 1px solid #e91e63;
            color: #e91e63;
        }

        .ref-physician.phys-liu {
            background: transparent;
            border: 1px solid #f39c12;
            color: #f39c12;
        }

        .ref-physician.phys-bacal {
            background: transparent;
            border: 1px solid #f1c40f;
            color: #f1c40f;
        }

        .ref-physician.phys-shapiro {
            background: transparent;
            border: 1px solid #34495e;
            color: #34495e;
        }

        .ref-physician.phys-greenblatt {
            background: transparent;
            border: 1px solid #27ae60;
            color: #27ae60;
        }

        .ref-physician.phys-other {
            background: transparent;
            border: 1px solid #95a5a6;
            color: #95a5a6;
        }

        .ref-location {
            text-align: center;
        }
        
        .ref-location .location-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: transparent;
            border: 1px solid #95a5a6;
            color: #95a5a6;
            white-space: nowrap;
        }

        /* Responsive: Stack on smaller screens */
        @media (max-width: 1600px) {
            .referrals-grid-header {
                display: none;
            }
            
            .referral-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .ref-name {
                font-size: 16px;
            }
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-new {
            background: #e74c3c;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .status-info-received {
            background: #3498db;
            color: white;
        }

        .status-deferred {
            background: #95a5a6;
            color: white;
        }

        .status-completed {
            background: #27ae60;
            color: white;
        }

        .referral-info {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            gap: 15px;
            margin-top: 3px;
            flex-wrap: wrap;
        }

        .referral-actions {
            display: flex;
            gap: 5px;
        }

        /* Footer */
        .footer { 
            text-align: center; 
            padding: 5px; 
            color: #95a5a6; 
            font-size: 12px; 
            margin-top: 20px; 
        }
        
        .footer .copyright { 
            margin-top: 5px; 
            font-size: 11px; 
            color: #b0b0b0; 
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
			background: white;
			padding: 20px;
			border-radius: 10px;
			max-width: 1000px;
			width: 100%;
			max-height: 90vh;
			display: flex;
			flex-direction: column;
			box-shadow: 0 10px 40px rgba(0,0,0,0.3);
		}

        .modal-content.large {
            max-width: 1000px;
        }

        .modal-header {
			flex-shrink: 0;  /* Don't let header shrink */
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 2px solid #ecf0f1;
		}

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

		.modal-body {
			margin-bottom: 15px;
			overflow-y: auto;
			flex: 1;
			max-height: calc(90vh - 150px);  /* Leave room for header and footer */
		}

		.modal-footer {
			flex-shrink: 0;
			display: flex;
			justify-content: center;
			gap: 10px;
			padding-top: 15px;
			border-top: 1px solid #ecf0f1;
		}

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #95a5a6;
        }

        .close-btn:hover {
            color: #7f8c8d;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 5px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .form-section-title {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* History List */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .history-date {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
        }

        .history-content {
            font-size: 13px;
            color: #2c3e50;
            margin-top: 3px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* Read-only Banner */
        #readOnlyBanner {
            display: none;
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        /* Utility */
        .text-muted { color: #7f8c8d; }
        .text-danger { color: #e74c3c; }
        .text-success { color: #27ae60; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .header-center { justify-content: center; margin: 10px 0; }
            .filters { flex-direction: column; width: 100%; }
            .kpi-summary { flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
        }
    
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <script type="text/javascript" src="/eel.js"></script>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <svg class="login-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 550 550"><path fill="#25ABE2" d="M17.1205 215.804C15.2512 213.98 3.89954 203.277 3.13166 201.696C3.96746 200.496 24.4409 195.072 28.0857 194.008L91.6641 175.791C93.3297 177.763 96.1202 183.18 97.646 185.723L98.7692 187.74L119.526 223.648C122.105 228.114 127.284 236.4 129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C81.9393 277.931 77.2785 273.737 73.1017 269.721L48.3392 245.87C40.9193 238.772 31.7108 229.121 24.1798 222.583C21.8072 220.223 19.5985 218.055 17.1205 215.804Z"/><path fill="#DC2C29" d="M129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C87.1982 281.299 95.6147 272.942 97.4191 271.243C108.068 261.219 118.524 250.489 129.305 240.615Z"/><path fill="#25ABE2" d="M369.669 96.1737C390.971 89.8571 412.76 83.9982 434.135 77.819C445.726 74.4681 458.042 70.5393 469.736 67.8083C469.149 70.0459 468.652 72.4249 468.142 74.6904L467.243 78.0757L454.223 129.716C451.905 139.071 449.754 148.715 447.126 157.969C442.855 157.616 437.793 157.734 433.433 157.734L412.978 157.735L389.211 157.747C384.728 157.751 379.386 157.63 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525L360.624 98.78C363.462 98.0718 366.819 97.005 369.669 96.1737Z"/><path fill="#DC2C29" d="M360.524 98.6525L360.624 98.78C360.761 101.314 362.888 108.581 363.542 111.429C366.043 122.318 369.125 133.191 371.703 144.072C372.763 148.543 374.155 153.453 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525Z"/><path fill="#25ABE2" d="M104.112 386.16C111.597 386.015 119.966 386.213 127.545 386.213L176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C187.521 445.778 182.293 447.477 179.194 448.359L155.893 455.087L94.4803 472.686C90.2246 473.945 85.7043 475.096 81.4007 476.217C82.8134 470.922 83.9962 465.165 85.3475 459.788L98.104 408.939C99.2889 404.23 102.39 389.669 104.112 386.16Z"/><path fill="#DC2C29" d="M176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C190.428 443.052 187.171 430.895 186.441 428.062L180.18 403.006C178.829 397.617 177.118 391.586 176.054 386.187Z"/><path fill="#25ABE2" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477L378.039 434.64L370.03 467.376C368.589 472.632 367.186 477.946 365.947 483.253C363.145 495.261 359.871 507.142 356.999 519.129L354.179 530.761L354.102 531.004C353.529 532.862 353.031 536.843 351.899 537.871C351.266 537.814 351.415 537.849 350.796 537.658C349.588 535.643 338.013 525.074 335.621 522.779L299.149 487.61L296.613 485.188C293.114 482.08 289.776 478.469 286.105 475.225C293.923 460.334 303.253 445.792 311.441 431.071C313.892 426.665 316.587 421.702 319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#DC2C29" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477C373.436 432.869 366.713 431.253 361.94 429.855L319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#25ABE2" d="M198.84 5.58799C204.614 10.4081 209.89 15.8699 215.324 21.098L241.962 46.7938L254.143 58.482C256.254 60.5282 262.475 66.7839 264.51 68.2112C264.663 69.1602 264.801 69.0228 264.298 69.9266C262.266 73.5786 260.092 77.2522 257.997 80.8644L245.789 101.968L236.682 117.729C235.28 120.161 233.184 124.266 231.516 126.413C228.522 125.2 219.738 122.888 216.37 121.921L186.351 113.342C183.252 112.462 175.686 110.555 172.99 109.411C176.973 92.0214 181.67 74.6125 185.906 57.2838L193.505 27.0218C195.233 20.0162 196.854 12.4681 198.84 5.58799Z"/><path fill="#FDAF19" d="M101.486 88.8467C104.016 89.7253 106.587 90.3149 109.161 91.0514L123.884 95.2716L153.812 103.814C159.099 105.305 167.755 107.541 172.725 109.411L172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C123.926 157.895 120.533 157.757 118.581 158.138C118.16 156.994 117.376 153.144 117.061 151.778C116.101 147.618 115.155 143.529 114.107 139.381L101.486 88.8467Z"/><path fill="#DC2C29" d="M172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C129.058 157.544 135.273 157.693 138.467 157.69L161.179 157.701C162.04 152.138 173.361 111.269 172.725 109.411L172.99 109.411Z"/><path fill="#FDAF19" d="M85.9258 282.128C89.0077 284.428 93.9369 289.446 96.8382 292.254L114.218 309.054C115.981 310.766 119.96 314.857 121.739 316.272C119.502 320.512 117.024 324.518 114.625 328.653C114.074 329.602 111.899 333.24 111.599 334.097C110.539 335.775 108.955 338.453 108.051 340.281C107.367 341.236 107.098 341.664 106.565 342.709C104.882 345.583 103.066 348.554 101.579 351.521C100.777 352.772 100.042 354.689 98.9702 355.118C97.2535 354.208 89.1585 351.975 86.9382 351.321L52.0742 341.324L48.3624 340.312C42.521 338.72 36.7055 336.957 30.9004 335.232C32.7025 333.091 35.2179 330.575 37.2664 328.618C51.3496 315.166 65.162 301.379 79.4367 288.137C81.4919 286.231 83.7705 283.805 85.9258 282.128Z"/><path fill="#FDAF19" d="M390.536 386.207L418.33 386.207C422.11 386.2 428.82 385.982 432.35 386.263C433.135 388.921 433.822 391.439 434.519 394.117L436.412 401.952C438.238 409.88 440.271 417.772 442.356 425.637C442.7 426.935 442.989 428.258 443.416 429.531C443.599 430.626 443.739 431.377 444.031 432.445C445.09 437.198 447.728 449.194 449.352 453.407L449.596 454.382L449.427 454.716C448.083 455.162 437.772 451.723 435.814 451.174L397.876 440.419C393.818 439.287 389.181 437.707 385.189 436.736C382.921 435.868 380.399 435.266 378.039 434.64L377.944 434.477C379.211 430.103 380.379 424.5 381.498 419.991L389.317 388.58C389.699 387.064 389.522 386.822 390.536 386.207Z"/><path fill="#FDAF19" d="M293.645 81.5672C298.241 76.1306 304.384 71.4223 309.44 66.4096C315.677 60.6778 321.485 53.6435 327.918 48.188C333.325 43.6033 338.534 37.6884 343.95 33.4048C345.173 36.1096 347.095 44.1829 347.945 47.4432C348.075 47.96 348.552 50.0487 348.748 50.3843C348.955 51.4388 349.154 52.5725 349.395 53.6123C351.202 61.3387 353.199 69.0207 355.209 76.6973C355.589 78.146 355.942 79.7492 356.408 81.1647C357.326 86.4982 359.215 93.2727 360.524 98.6525C357.689 100.939 318.472 110.484 311.753 113.078C308.598 108.386 304.958 101.422 301.966 96.3799C299.734 92.6201 295.381 85.3541 293.645 81.5672Z"/><path fill="#FDAF19" d="M239.269 430.708L251.532 451.853C252.541 453.594 255.965 459.808 257.046 461.148C257.174 461.927 257.392 462.136 256.9 462.644C254.487 465.134 251.695 467.75 249.206 470.143L229.338 489.284C227.751 490.811 221.269 496.808 220.147 498.213C219.197 499.097 215.312 502.681 214.766 503.471C213.474 504.616 207.762 510.415 206.84 510.59C205.616 507.49 203.56 497.663 202.619 493.859L193.885 459.067C193.577 457.622 193.287 456.451 192.893 455.026C192.582 453.586 192.4 452.615 191.863 451.223C191.612 449.548 190.978 447.102 190.591 445.393C190.699 445.235 190.808 445.077 190.916 444.919C204.77 440.608 219.228 436.842 233.099 432.704C236.705 431.628 237.355 431.701 239.269 430.708Z"/><path fill="#25ABE2" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C468.441 265.221 474.007 270.912 477.403 273.671C487.898 284.224 499.362 294.866 510.098 305.223C521.591 316.309 533.226 327.867 544.865 338.759C545.611 339.475 547.258 341.187 548.082 341.586L548.31 342.415C547.799 343.112 546.929 343.148 545.918 343.443L542.434 344.438L504.138 355.382C502.972 355.687 501.468 356.027 500.364 356.428C499.101 356.683 497.879 357.007 496.651 357.393C486.574 360.566 476.253 363.13 466.161 366.204C464.258 366.783 461.069 367.834 459.222 368.14C454.784 360.817 450.302 352.778 446.001 345.334L421.784 303.437L403.624 272.104Z"/><path fill="#DC2C29" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C462.097 264.164 454.938 271.664 451.919 274.492C441.848 283.922 431.941 294.133 421.784 303.437L403.624 272.104Z"/><path fill="#FDAF19" d="M451.487 189.086C455.312 190.444 462.169 192.077 466.53 193.38C484.248 198.676 502.576 203.39 520.258 208.744C518.42 210.635 516.561 212.437 514.67 214.272C511.351 217.055 506.557 222.008 503.291 225.183L465.133 261.937C462.623 260.08 456.016 253.452 453.494 251.027L429.28 227.577C435.69 216.108 442.389 204.801 448.895 193.387C449.724 191.932 450.597 190.504 451.487 189.086Z"/></svg>
                <h1>MSF Referrals Management</h1>
                <p>Please login to continue</p>
            </div>
            
            <div id="loginError" class="error-message"></div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <!-- Read-Only Banner -->
            <div id="readOnlyBanner">
                ðŸ”’ READ-ONLY MODE - Database is being edited by <span id="lockOwnerName"></span>
            </div>

            <!-- Header -->
            <header>
                <div class="header-content">
                    <div class="header-left">
                        <div class="logo-container">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 550 550"><path fill="#25ABE2" d="M17.1205 215.804C15.2512 213.98 3.89954 203.277 3.13166 201.696C3.96746 200.496 24.4409 195.072 28.0857 194.008L91.6641 175.791C93.3297 177.763 96.1202 183.18 97.646 185.723L98.7692 187.74L119.526 223.648C122.105 228.114 127.284 236.4 129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C81.9393 277.931 77.2785 273.737 73.1017 269.721L48.3392 245.87C40.9193 238.772 31.7108 229.121 24.1798 222.583C21.8072 220.223 19.5985 218.055 17.1205 215.804Z"/><path fill="#DC2C29" d="M129.305 240.615C134.559 249.436 139.557 258.422 144.759 267.276C145.607 268.719 146.455 270.378 147.387 271.754C146.359 274.092 144.315 277.391 143.015 279.694C139.776 285.431 136.298 291.026 133.141 296.821C131.68 299.295 129.769 302.351 128.447 304.846C127.746 306.087 126.913 307.484 126.282 308.744C125.008 310.678 123.912 312.704 122.782 314.725L121.739 316.272C119.96 314.857 115.981 310.766 114.218 309.054L96.8382 292.254C93.9369 289.446 89.0077 284.428 85.9258 282.128L85.9517 282.04C87.1982 281.299 95.6147 272.942 97.4191 271.243C108.068 261.219 118.524 250.489 129.305 240.615Z"/><path fill="#25ABE2" d="M369.669 96.1737C390.971 89.8571 412.76 83.9982 434.135 77.819C445.726 74.4681 458.042 70.5393 469.736 67.8083C469.149 70.0459 468.652 72.4249 468.142 74.6904L467.243 78.0757L454.223 129.716C451.905 139.071 449.754 148.715 447.126 157.969C442.855 157.616 437.793 157.734 433.433 157.734L412.978 157.735L389.211 157.747C384.728 157.751 379.386 157.63 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525L360.624 98.78C363.462 98.0718 366.819 97.005 369.669 96.1737Z"/><path fill="#DC2C29" d="M360.524 98.6525L360.624 98.78C360.761 101.314 362.888 108.581 363.542 111.429C366.043 122.318 369.125 133.191 371.703 144.072C372.763 148.543 374.155 153.453 374.971 157.902C366.34 157.809 357.741 157.887 349.117 157.897C346.991 157.9 339.185 158.057 337.608 157.752L337.369 157.48C336.802 156.067 331.935 148.209 330.86 146.301C324.59 135.178 317.963 124.248 311.753 113.078C318.472 110.484 357.689 100.939 360.524 98.6525Z"/><path fill="#25ABE2" d="M104.112 386.16C111.597 386.015 119.966 386.213 127.545 386.213L176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C187.521 445.778 182.293 447.477 179.194 448.359L155.893 455.087L94.4803 472.686C90.2246 473.945 85.7043 475.096 81.4007 476.217C82.8134 470.922 83.9962 465.165 85.3475 459.788L98.104 408.939C99.2889 404.23 102.39 389.669 104.112 386.16Z"/><path fill="#DC2C29" d="M176.054 386.187C181.396 386.233 210.901 385.588 213.369 386.677C215.238 388.643 223.574 403.271 225.427 406.693C229.393 414.019 235.551 423.428 239.269 430.708C237.355 431.701 236.705 431.628 233.099 432.704C219.228 436.842 204.77 440.608 190.916 444.919C190.808 445.077 190.699 445.235 190.591 445.393L190.506 445.209C190.428 443.052 187.171 430.895 186.441 428.062L180.18 403.006C178.829 397.617 177.118 391.586 176.054 386.187Z"/><path fill="#25ABE2" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477L378.039 434.64L370.03 467.376C368.589 472.632 367.186 477.946 365.947 483.253C363.145 495.261 359.871 507.142 356.999 519.129L354.179 530.761L354.102 531.004C353.529 532.862 353.031 536.843 351.899 537.871C351.266 537.814 351.415 537.849 350.796 537.658C349.588 535.643 338.013 525.074 335.621 522.779L299.149 487.61L296.613 485.188C293.114 482.08 289.776 478.469 286.105 475.225C293.923 460.334 303.253 445.792 311.441 431.071C313.892 426.665 316.587 421.702 319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#DC2C29" d="M337.748 386.29C343.436 386.022 350.58 386.211 356.357 386.209L390.536 386.207C389.522 386.822 389.699 387.064 389.317 388.58L381.498 419.991C380.379 424.5 379.211 430.103 377.944 434.477C373.436 432.869 366.713 431.253 361.94 429.855L319.432 417.584C325.525 408.146 331.368 395.476 337.748 386.29Z"/><path fill="#25ABE2" d="M198.84 5.58799C204.614 10.4081 209.89 15.8699 215.324 21.098L241.962 46.7938L254.143 58.482C256.254 60.5282 262.475 66.7839 264.51 68.2112C264.663 69.1602 264.801 69.0228 264.298 69.9266C262.266 73.5786 260.092 77.2522 257.997 80.8644L245.789 101.968L236.682 117.729C235.28 120.161 233.184 124.266 231.516 126.413C228.522 125.2 219.738 122.888 216.37 121.921L186.351 113.342C183.252 112.462 175.686 110.555 172.99 109.411C176.973 92.0214 181.67 74.6125 185.906 57.2838L193.505 27.0218C195.233 20.0162 196.854 12.4681 198.84 5.58799Z"/><path fill="#FDAF19" d="M101.486 88.8467C104.016 89.7253 106.587 90.3149 109.161 91.0514L123.884 95.2716L153.812 103.814C159.099 105.305 167.755 107.541 172.725 109.411L172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C123.926 157.895 120.533 157.757 118.581 158.138C118.16 156.994 117.376 153.144 117.061 151.778C116.101 147.618 115.155 143.529 114.107 139.381L101.486 88.8467Z"/><path fill="#DC2C29" d="M172.99 109.411C175.686 110.555 183.252 112.462 186.351 113.342L216.37 121.921C219.738 122.888 228.522 125.2 231.516 126.413L230.859 127.854C229.261 130.316 227.469 133.615 225.978 136.213C222.403 142.358 216.688 151.61 213.616 157.749C210.296 158.037 204.526 157.874 201.024 157.87L178.606 157.847C161.554 157.832 142.951 158.342 126.084 157.854C129.058 157.544 135.273 157.693 138.467 157.69L161.179 157.701C162.04 152.138 173.361 111.269 172.725 109.411L172.99 109.411Z"/><path fill="#FDAF19" d="M85.9258 282.128C89.0077 284.428 93.9369 289.446 96.8382 292.254L114.218 309.054C115.981 310.766 119.96 314.857 121.739 316.272C119.502 320.512 117.024 324.518 114.625 328.653C114.074 329.602 111.899 333.24 111.599 334.097C110.539 335.775 108.955 338.453 108.051 340.281C107.367 341.236 107.098 341.664 106.565 342.709C104.882 345.583 103.066 348.554 101.579 351.521C100.777 352.772 100.042 354.689 98.9702 355.118C97.2535 354.208 89.1585 351.975 86.9382 351.321L52.0742 341.324L48.3624 340.312C42.521 338.72 36.7055 336.957 30.9004 335.232C32.7025 333.091 35.2179 330.575 37.2664 328.618C51.3496 315.166 65.162 301.379 79.4367 288.137C81.4919 286.231 83.7705 283.805 85.9258 282.128Z"/><path fill="#FDAF19" d="M390.536 386.207L418.33 386.207C422.11 386.2 428.82 385.982 432.35 386.263C433.135 388.921 433.822 391.439 434.519 394.117L436.412 401.952C438.238 409.88 440.271 417.772 442.356 425.637C442.7 426.935 442.989 428.258 443.416 429.531C443.599 430.626 443.739 431.377 444.031 432.445C445.09 437.198 447.728 449.194 449.352 453.407L449.596 454.382L449.427 454.716C448.083 455.162 437.772 451.723 435.814 451.174L397.876 440.419C393.818 439.287 389.181 437.707 385.189 436.736C382.921 435.868 380.399 435.266 378.039 434.64L377.944 434.477C379.211 430.103 380.379 424.5 381.498 419.991L389.317 388.58C389.699 387.064 389.522 386.822 390.536 386.207Z"/><path fill="#FDAF19" d="M293.645 81.5672C298.241 76.1306 304.384 71.4223 309.44 66.4096C315.677 60.6778 321.485 53.6435 327.918 48.188C333.325 43.6033 338.534 37.6884 343.95 33.4048C345.173 36.1096 347.095 44.1829 347.945 47.4432C348.075 47.96 348.552 50.0487 348.748 50.3843C348.955 51.4388 349.154 52.5725 349.395 53.6123C351.202 61.3387 353.199 69.0207 355.209 76.6973C355.589 78.146 355.942 79.7492 356.408 81.1647C357.326 86.4982 359.215 93.2727 360.524 98.6525C357.689 100.939 318.472 110.484 311.753 113.078C308.598 108.386 304.958 101.422 301.966 96.3799C299.734 92.6201 295.381 85.3541 293.645 81.5672Z"/><path fill="#FDAF19" d="M239.269 430.708L251.532 451.853C252.541 453.594 255.965 459.808 257.046 461.148C257.174 461.927 257.392 462.136 256.9 462.644C254.487 465.134 251.695 467.75 249.206 470.143L229.338 489.284C227.751 490.811 221.269 496.808 220.147 498.213C219.197 499.097 215.312 502.681 214.766 503.471C213.474 504.616 207.762 510.415 206.84 510.59C205.616 507.49 203.56 497.663 202.619 493.859L193.885 459.067C193.577 457.622 193.287 456.451 192.893 455.026C192.582 453.586 192.4 452.615 191.863 451.223C191.612 449.548 190.978 447.102 190.591 445.393C190.699 445.235 190.808 445.077 190.916 444.919C204.77 440.608 219.228 436.842 233.099 432.704C236.705 431.628 237.355 431.701 239.269 430.708Z"/><path fill="#25ABE2" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C468.441 265.221 474.007 270.912 477.403 273.671C487.898 284.224 499.362 294.866 510.098 305.223C521.591 316.309 533.226 327.867 544.865 338.759C545.611 339.475 547.258 341.187 548.082 341.586L548.31 342.415C547.799 343.112 546.929 343.148 545.918 343.443L542.434 344.438L504.138 355.382C502.972 355.687 501.468 356.027 500.364 356.428C499.101 356.683 497.879 357.007 496.651 357.393C486.574 360.566 476.253 363.13 466.161 366.204C464.258 366.783 461.069 367.834 459.222 368.14C454.784 360.817 450.302 352.778 446.001 345.334L421.784 303.437L403.624 272.104Z"/><path fill="#DC2C29" d="M403.624 272.104C406.324 266.599 411.694 258.055 414.867 252.529C419.544 244.384 424.477 235.629 429.28 227.577L453.494 251.027C456.016 253.452 462.623 260.08 465.133 261.937L465.138 262.03C462.097 264.164 454.938 271.664 451.919 274.492C441.848 283.922 431.941 294.133 421.784 303.437L403.624 272.104Z"/><path fill="#FDAF19" d="M451.487 189.086C455.312 190.444 462.169 192.077 466.53 193.38C484.248 198.676 502.576 203.39 520.258 208.744C518.42 210.635 516.561 212.437 514.67 214.272C511.351 217.055 506.557 222.008 503.291 225.183L465.133 261.937C462.623 260.08 456.016 253.452 453.494 251.027L429.28 227.577C435.69 216.108 442.389 204.801 448.895 193.387C449.724 191.932 450.597 190.504 451.487 189.086Z"/></svg>
                        </div>
                        <h1>MSF Referrals Management</h1>
                    </div>
                    <div class="header-center">
                        <button onclick="openAddReferralModal()" class="btn btn-primary" id="addReferralBtn">+ Add Referral</button>
                        <button onclick="saveDatabase()" class="btn btn-success" id="saveButton">Save</button>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>From:</label>
                            <input type="text" class="date-input" id="dateFrom" placeholder="Start">
                        </div>
                        <div class="filter-group">
                            <label>To:</label>
                            <input type="text" class="date-input" id="dateTo" placeholder="End">
                        </div>
                        <button class="btn btn-success" onclick="resetFilters()">Reset</button>
                        <button onclick="logout()" class="btn btn-secondary">Logout</button>
                    </div>
                </div>
            </header>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-text" id="statusBar">
                    <strong>Database: <span id="currentFile">No file loaded</span></strong>
                </div>
            </div>

            <!-- KPI Summary -->
            <div class="kpi-summary">
                <div class="kpi-card">
                    <div class="kpi-label">Total Referrals</div>
                    <div class="kpi-value" id="kpiTotal">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">New Patients</div>
                    <div class="kpi-value" id="kpiNew">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Waiting for Contact</div>
                    <div class="kpi-value" id="kpiWaitingContact">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Pending</div>
                    <div class="kpi-value" id="kpiPending">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Completed</div>
                    <div class="kpi-value" id="kpiCompleted">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Deferred</div>
                    <div class="kpi-value" id="kpiDeferred">-</div>
                </div>
            </div>

            <!-- Referrals List Card -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="card-title" style="margin-bottom: 0;">All Referrals (<span id="referralCount">0</span>)</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="sort-btn active" id="sortID" onclick="setSortMode('id')">ID</button>
                        <button class="sort-btn" id="sortNameAZ" onclick="setSortMode('name-az')">Name Aâ†’Z</button>
                        <button class="sort-btn" id="sortAttemptOld" onclick="setSortMode('attempt-old')">Last Attempt (Oldâ†’New)</button>
                        <button class="sort-btn" id="sortAttemptNew" onclick="setSortMode('attempt-new')">Last Attempt (Newâ†’Old)</button>
                        <button class="sort-btn" id="sortReceivedOld" onclick="setSortMode('received-old')">Received (Oldâ†’New)</button>
                        <button class="sort-btn" id="sortReceivedNew" onclick="setSortMode('received-new')">Received (Newâ†’Old)</button>
                    </div>
                </div>
                <div class="filter-buttons" id="filterButtons">
                    <button class="filter-btn active" onclick="filterByStatus('all')">All</button>
                    <button class="filter-btn" onclick="filterByStatus('new')">New<br>Patient</button>
                    <button class="filter-btn" onclick="filterByStatus('previous')">Previous<br>Patient</button>
                    <button class="filter-btn" onclick="filterByStatus('partner')">Partner</button>
                    <button class="filter-btn" onclick="filterByStatus('new-referral')">New<br>Referral</button>
                    <button class="filter-btn" onclick="filterByStatus('pending')">Pending</button>
                    <button class="filter-btn" onclick="filterByStatus('info-received')">Info<br>Received</button>
                    <button class="filter-btn" onclick="filterByStatus('completed')">Completed</button>
                    <button class="filter-btn" onclick="filterByStatus('deferred')">Deferred</button>
                    <button class="filter-btn" onclick="filterByStatus('contact-2days')">Contact<br>> 2 days</button>
                    <button class="filter-btn" onclick="filterByStatus('contact-3days')">Contact<br>> 3 days</button>
                    <button class="filter-btn" onclick="filterByStatus('contact-7days')">Contact<br>> 7 days</button>
                    <button class="filter-btn" onclick="filterByStatus('no-contact')">No<br>Contact</button>
                    <button class="filter-btn" onclick="filterByStatus('no-email')">No<br>Email</button>
                </div>
                <input type="text" class="search-box" id="searchBox" placeholder="Search referrals..." oninput="filterReferrals()">
                <div class="referrals-grid-header">
                    <div>âš ï¸</div>
                    <div>ðŸ“„</div>
                    <div>Patient Name</div>
                    <div>ðŸ“Š Status</div>
                    <div>Type</div>
                    <div>ðŸŽ‚ DOB</div>
                    <div>Age</div>
                    <div>ðŸ“… Received</div>
                    <div>ðŸ”„ Last Contact</div>
                    <div>No. Contact</div>
                    <div>Service</div>
                    <div>ðŸ‘¨â€âš•ï¸ Physician</div>
                    <div>ðŸ“ Loc</div>
                    <div>ðŸ“ž Phone</div>
                    <div>ðŸ“§ Email</div>
                </div>
                <div class="referral-list" id="referralList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“‹</div>
                        <div class="empty-state-text">No referrals found</div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div>MSF Referrals Management Dashboard</div>
                <div class="copyright">&copy; Dr. Jennia Michaeli | Mount Sinai Fertility</div>
            </footer>
        </div>

		<!-- Add/Edit Referral Modal -->
		<div id="referralModal" class="modal">
			<div class="modal-content large">
				<div class="modal-header">
					<h2 class="modal-title" id="referralModalTitle">Add New Referral</h2>
					<button type="button" class="close-btn" onclick="closeModal('referralModal')">&times;</button>
				</div>
				
				<div class="modal-body">
					<form id="referralForm" onsubmit="return false;">
						<!-- Referral Information -->
						<div class="form-section">
							<div class="form-section-title">Referral Information</div>
							
							<div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
								<div class="form-group">
									<label class="required">Referral Date</label>
									<input type="text" id="referralDate" class="datepicker" required>
								</div>
								<div class="form-group">
									<label class="required">Received Date</label>
									<input type="text" id="receivedDate" class="datepicker" required>
								</div>
								<div class="form-group">
									<label>File Name</label>
									<div style="display: flex; gap: 5px;">
										<input type="text" id="fileName" readonly 
											   style="background: #f0f0f0; flex: 1; cursor: pointer;" 
											   onclick="selectFile()" 
											   placeholder="Click to select file...">
										<button type="button" onclick="viewSelectedFile()" 
												class="btn btn-primary btn-small" 
												id="viewFileBtn" 
												style="display: none;">View</button>
									</div>
								</div>
							</div>
							
							<div class="form-row" style="grid-template-columns: 2fr 1fr 1fr;">
								<div class="form-group">
									<label class="required">Referring Physician Name</label>
									<input type="text" id="referringPhysician" required>
								</div>
								<div class="form-group">
									<label class="required">Billing Number</label>
									<input type="text" id="billingNumber" required>
								</div>
								<div class="form-group">
									<label class="required">Fax</label>
									<input type="text" id="physicianFax" required>
								</div>
							</div>
							
							<div class="form-row">
								<div class="form-group">
									<label>Phone</label>
									<input type="text" id="physicianPhone">
								</div>
								<div class="form-group">
									<label>Email</label>
									<input type="email" id="physicianEmail">
								</div>
							</div>
						</div>

						<!-- Service Information -->
						<div class="form-section">
							<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
								<div class="form-section-title" style="margin-bottom: 0;">Service Information</div>
								<div class="checkbox-group">
									<input type="checkbox" id="urgent">
									<label for="urgent" style="color: #e74c3c; font-weight: 600; font-size: 14px;">âš ï¸ URGENT</label>
								</div>
							</div>
							
							<div class="form-row">
								<div class="form-group">
									<label class="required">Requested Location</label>
									<select id="requestedLocation" required>
										<option value="">Select location...</option>
									</select>
								</div>
								<div class="form-group">
									<label class="required">Requested Physician</label>
									<select id="requestedPhysician" required>
										<option value="">Select physician...</option>
									</select>
								</div>
							</div>
							
							<div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
								<div class="form-group">
									<label class="required">Referral Type</label>
									<select id="referralType" required>
										<option value="">Select...</option>
									</select>
								</div>
								<div class="form-group">
									<label class="required">Service Requested</label>
									<select id="serviceRequested" required>
										<option value="">Select service...</option>
									</select>
								</div>
								<div class="form-group">
									<label>Sub Service Requested</label>
									<input type="text" id="subServiceRequested">
								</div>
							</div>
						</div>

						<!-- Patient and Partner Information -->
						<div class="form-section">
							<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
								<div class="form-section-title" style="margin-bottom: 0;">Patient and Partner Information</div>
								<div class="checkbox-group">
									<input type="checkbox" id="enablePartner" onchange="togglePartnerFields()">
									<label for="enablePartner">Include Partner</label>
								</div>
							</div>
							
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
								<!-- Patient Column -->
								<div>
									<div style="font-weight: 600; margin-bottom: 10px; color: #667eea;">Patient</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>PID</label>
											<input type="text" id="patientPID">
										</div>
										<div class="form-group">
											<label>MRN</label>
											<input type="text" id="patientMRN">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label class="required">First Name</label>
											<input type="text" id="patientFirstName" required>
										</div>
										<div class="form-group">
											<label class="required">Last Name</label>
											<input type="text" id="patientLastName" required>
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Middle Name</label>
											<input type="text" id="patientMiddleName">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label class="required">Date of Birth</label>
											<input type="text" id="patientDOB" class="datepicker" required>
										</div>
										<div class="form-group">
											<label>Age</label>
											<input type="text" id="patientAge" readonly style="background-color: #f8f9fa;">
										</div>
										<div class="form-group">
											<label>Gender at Birth</label>
											<select id="patientGenderAtBirth">
												<option value="">Select...</option>
											</select>
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Phone</label>
											<input type="tel" id="patientPhone">
										</div>
										<div class="form-group">
											<label>Email</label>
											<input type="email" id="patientEmail">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Address</label>
											<input type="text" id="patientAddress">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Health Card</label>
											<input type="text" id="patientHC">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Emergency Contact Name</label>
											<input type="text" id="emergencyContact">
										</div>
										<div class="form-group">
											<label>Emergency Contact Relationship</label>
											<input type="text" id="emergencyContactRelationship">
										</div>
									</div>
								</div>
								
								<!-- Partner Column -->
								<div id="partnerSection" style="opacity: 0.4; pointer-events: none;">
									<div style="font-weight: 600; margin-bottom: 10px; color: #95a5a6;">Partner</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>PID</label>
											<input type="text" id="partnerPID">
										</div>
										<div class="form-group">
											<label>MRN</label>
											<input type="text" id="partnerMRN">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>First Name</label>
											<input type="text" id="partnerFirstName">
										</div>
										<div class="form-group">
											<label>Last Name</label>
											<input type="text" id="partnerLastName">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Middle Name</label>
											<input type="text" id="partnerMiddleName">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Date of Birth</label>
											<input type="text" id="partnerDOB" class="datepicker">
										</div>
										<div class="form-group">
											<label>Age</label>
											<input type="text" id="partnerAge" readonly style="background-color: #f8f9fa;">
										</div>
										<div class="form-group">
											<label>Gender at Birth</label>
											<select id="partnerGenderAtBirth">
												<option value="">Select...</option>
											</select>
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Phone</label>
											<input type="tel" id="partnerPhone">
										</div>
										<div class="form-group">
											<label>Email</label>
											<input type="email" id="partnerEmail">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Address</label>
											<input type="text" id="partnerAddress">
										</div>
									</div>
									
									<div class="form-row full">
										<div class="form-group">
											<label>Health Card</label>
											<input type="text" id="partnerHC">
										</div>
									</div>
									
									<div class="form-row">
										<div class="form-group">
											<label>Emergency Contact Name</label>
											<input type="text" id="partnerEmergencyContact">
										</div>
										<div class="form-group">
											<label>Emergency Contact Relationship</label>
											<input type="text" id="partnerEmergencyContactRelationship">
										</div>
									</div>
								</div>
							</div>
						</div>
				
				<div class="modal-footer">
					<button type="button" onclick="closeModal('referralModal')" class="btn btn-secondary">Cancel</button>
					<button type="button" onclick="saveReferral()" class="btn btn-success" id="saveReferralBtn">Save Referral</button>
				</div>
			</div>
		</div>
    </div>

	<!-- PDF Viewer (no modal backdrop - positioned to the right) -->
	<div id="pdfViewerModal" style="
		display: none;
		position: fixed;
		top: 5%;
		right: 1%;
		width: 46%;
		height: 90vh;
		z-index: 1001;
		background: white;
		border-radius: 10px;
		box-shadow: 0 10px 40px rgba(0,0,0,0.4);
		flex-direction: column;
	">
		<div style="
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 15px;
			border-bottom: 2px solid #ecf0f1;
			flex-shrink: 0;
		">
			<strong id="pdfViewerTitle">File Preview</strong>
		</div>
		<iframe id="pdfFrame" style="
			flex: 1;
			width: 100%;
			border: none;
			height: calc(100% - 50px);
		"></iframe>
	</div>

    <!-- Modals will go here - keeping from previous version -->
    <!-- (Add/Edit Referral Modal, View Referral Modal, Contact Modal, Assign Admin Modal) -->
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    
    <script>
        // Global state - UPDATED FOR SQLITE
        let database = null;  // Keep for compatibility
        let currentUser = null;
        let isReadOnly = false;
        let unsavedChanges = 0;
        let currentEditingReferral = null;
        let currentViewingReferral = null;
        let autoSaveInterval = null;
        let currentSortMode = 'id';
        let currentFilter = [];
        
        // SQLite Backend State
        let currentFilters = {};
        let currentSort = { by: 'id', order: 'asc' };
        let currentOffset = 0;
        let isLoading = false;
        let hasMore = true;
        let allLoadedReferrals = [];
        let selectOptions = {};
        let totalReferralsCount = 0;

        
        // ========== SQLITE BACKEND FUNCTIONS ==========
        
        async function loadSelectOptions() {
            const result = await eel.get_select_options()();
            if (result.status === 'success') {
                selectOptions = result.options;
            }
        }
        
        async function loadReferrals(reset = false) {
            if (isLoading) return;
            if (!hasMore && !reset) return;
            
            if (reset) {
                currentOffset = 0;
                hasMore = true;
                allLoadedReferrals = [];
            }
            
            isLoading = true;
            
            currentFilters = {
                statuses: getActiveFilterButtons(),
                search: document.getElementById('searchBox')?.value || '',
                dateFrom: document.getElementById('dateFrom')?.value || '',
                dateTo: document.getElementById('dateTo')?.value || ''
            };
            
            const result = await eel.get_referrals(
                currentFilters,
                currentSort.by,
                currentSort.order,
                currentOffset,
                100
            )();
            
            if (result.status === 'success') {
                if (reset) {
                    allLoadedReferrals = result.referrals;
                } else {
                    allLoadedReferrals = allLoadedReferrals.concat(result.referrals);
                }
                
                hasMore = result.hasMore;
                currentOffset += result.referrals.length;
                totalReferralsCount = result.total;
                
                renderReferralList();
                updateReferralCount(result.total);
            }
            
            isLoading = false;
        }
        
        function getActiveFilterButtons() {
            // Return the currentFilter array that's managed by filterByStatus()
            return currentFilter.length > 0 ? currentFilter : null;
        }
        
        function updateReferralCount(count) {
            const countEl = document.getElementById('referralCount');
            if (countEl) {
                countEl.textContent = count;
            }
        }
        
        // ==============================================

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MSF Referrals Management loaded');
        });

        // Login handling
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                const result = await eel.login(username, password)();
                
                if (result.status === 'success') {
                    currentUser = username;
                    isReadOnly = result.readOnly;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    if (isReadOnly) {
                        document.getElementById('readOnlyBanner').style.display = 'block';
                        disableEditingControls();
                    }
                    
                    await initializeApp();
                } else if (result.status === 'locked') {
                    const readOnlyChoice = confirm(
                        `Database is currently locked by ${result.user}\n\n` +
                        `Click OK to open in Read-Only mode (you can view but not edit).\n` +
                        `Click Cancel to return to login.`
                    );
                    
                    if (readOnlyChoice) {
                        await eel.login_readonly(username)();
                        currentUser = username;
                        isReadOnly = true;
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('readOnlyBanner').style.display = 'block';
                        document.getElementById('lockOwnerName').textContent = result.user;
                        disableEditingControls();
                        await initializeApp();
                    }
                } else {
                    errorDiv.textContent = result.message || 'Login failed';
                    errorDiv.style.display = 'block';
                    document.getElementById('loginPassword').value = '';
                }
            } catch (error) {
				console.error('Login error:', error);
				errorDiv.textContent = 'Connection error: Cannot connect to application. Please close and restart the application.';
				errorDiv.style.display = 'block';
			}
        }

        // Logout
        async function logout() {
            if (unsavedChanges > 0) {
                const choice = confirm(`You have ${unsavedChanges} unsaved change(s)!\n\nClick OK to save and logout, or Cancel to logout without saving.`);
                if (choice) {
                    await saveDatabase();
                }
            }
            
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            
            await eel.logout()();
            
            currentUser = null;
            isReadOnly = false;
            unsavedChanges = 0;
            
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('readOnlyBanner').style.display = 'none';
        }

        // Initialize app
        async function initializeApp() {
            // Load from SQLite backend
            await loadSelectOptions();
            populateSelectOptions(); // Populate dropdown menus
            await loadReferrals(true);
            await updateKPIs();
            
            document.getElementById('currentFile').textContent = 'DB\\referrals.db';
            
            // Initialize date pickers
            flatpickr('#dateFrom', {
                dateFormat: 'Y-m-d',
                allowInput: true,
                onChange: function() { filterReferrals(); updateKPIs(); }
            });
            flatpickr('#dateTo', {
                dateFormat: 'Y-m-d',
                allowInput: true,
                onChange: function() { filterReferrals(); updateKPIs(); }
            });				
            
            if (!isReadOnly) {
                autoSaveInterval = setInterval(async () => {
                    // SQLite auto-saves on each operation, no need for periodic save
                    // Just refresh lock file
                }, 5 * 60 * 1000);
            }
        }

		// Initialize date pickers (add after initializeApp function)
		flatpickr('#dateFrom', {
			dateFormat: 'Y-m-d',
			allowInput: true,
			onChange: function() {
				filterReferrals();
			}
		});

		flatpickr('#dateTo', {
			dateFormat: 'Y-m-d',
			allowInput: true,
			onChange: function() {
				filterReferrals();
			}
		});

        // Disable editing controls in read-only mode
        function disableEditingControls() {
            document.getElementById('saveButton').disabled = true;
            document.getElementById('saveButton').style.opacity = '0.5';
            document.getElementById('addReferralBtn').disabled = true;
            document.getElementById('addReferralBtn').style.opacity = '0.5';
        }

        // Save database - NOT NEEDED WITH SQLITE (auto-saves on each operation)
		async function saveDatabase(silent = false) {
			// SQLite backend saves automatically on each add/update/delete
			// No need for manual save
			return;
		}

        // Update KPIs
        async function updateKPIs() {
            const dateFilters = {
                dateFrom: document.getElementById('dateFrom')?.value || '',
                dateTo: document.getElementById('dateTo')?.value || ''
            };
            
            const result = await eel.get_kpi_counts(dateFilters)();
            
            document.getElementById('kpiTotal').textContent = result.total || 0;
            document.getElementById('kpiNew').textContent = result.new || 0;
            document.getElementById('kpiPending').textContent = result.pending || 0;
            document.getElementById('kpiCompleted').textContent = result.completed || 0;
            document.getElementById('kpiDeferred').textContent = result.deferred || 0;
            document.getElementById('kpiWaitingContact').textContent = result.waitingContact || 0;
        }

        // Render referral list
        function renderReferralList() {
            const container = document.getElementById('referralList');
            const referrals = allLoadedReferrals;
            
            document.getElementById('referralCount').textContent = referrals.length;
            
            if (referrals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“‹</div>
                        <div class="empty-state-text">No referrals found</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = referrals.map(ref => {
                const patientName = `${ref.patientLastName || ''}, ${ref.patientFirstName || ''}`.trim();
                const receivedDate = ref.receivedDate || '';
                const lastContact = ref.lastAttemptDate || '';
                const phone = ref.patientPhone || '';
                const email = ref.patientEmail || '';
                const service = ref.serviceRequested || '';
                const physician = ref.requestedPhysician || '';
                const dob = ref.patientDOB || '';
                
                // Calculate age
                let age = '';
                let ageClass = '';
                if (dob) {
                    const birthDate = new Date(dob);
                    const today = new Date();
                    let calculatedAge = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        calculatedAge--;
                    }
                    age = calculatedAge;
                    if (calculatedAge > 43) {
                        ageClass = 'red';
                    }
                }
                
                // Referral type badge
                let typeClass = '';
                let typeText = '';
                if (ref.referralType === 'New') {
                    typeClass = 'type-new';
                    typeText = 'New';
                } else if (ref.referralType === 'Previous') {
                    typeClass = 'type-previous';
                    typeText = 'Prev';
                } else if (ref.referralType === 'Partner') {
                    typeClass = 'type-partner';
                    typeText = 'Partner';
                }
                
                let statusClass = '';
                switch(ref.referralStatus) {
                    case 'New': statusClass = 'status-new'; break;
                    case 'Pending': statusClass = 'status-pending'; break;
                    case 'Info Received': statusClass = 'status-info-received'; break;
                    case 'Deferred': statusClass = 'status-deferred'; break;
                    case 'Completed': statusClass = 'status-completed'; break;
                }
                
                // Physician badge class
                let physicianClass = 'phys-other';
                if (physician.includes('First Available')) physicianClass = 'phys-first-available';
                else if (physician.includes('Michaeli')) physicianClass = 'phys-michaeli';
                else if (physician.includes('Russo')) physicianClass = 'phys-russo';
                else if (physician.includes('Pereira')) physicianClass = 'phys-pereira';
                else if (physician.includes('Jones')) physicianClass = 'phys-jones';
                else if (physician.includes('Liu')) physicianClass = 'phys-liu';
                else if (physician.includes('Bacal')) physicianClass = 'phys-bacal';
                else if (physician.includes('Shapiro')) physicianClass = 'phys-shapiro';
                else if (physician.includes('Greenblatt')) physicianClass = 'phys-greenblatt';
                
                // Urgent icon
                const urgentIcon = ref.urgent ? 'âš ï¸' : '';
                
                // File icon
                const fileIcon = ref.fileName ? 'ðŸ“„' : '';
                
                // Location abbreviation
                let locationText = '';
                let locationHTML = '';
                if (ref.requestedLocation) {
                    if (ref.requestedLocation === 'Downtown') locationText = 'ðŸ“ DT';
                    else if (ref.requestedLocation === 'Vaughan') locationText = 'ðŸ“ VGN';
                    else if (ref.requestedLocation === 'Mississauga') locationText = 'ðŸ“ MISS';
                    
                    // Only create badge HTML if we have a location
                    if (locationText) {
                        locationHTML = `<span class="location-badge">${locationText}</span>`;
                    }
                }
                
                // Use phoneAttempts and emailAttempts from database (already calculated!)
                const phoneCount = ref.phoneAttempts || 0;
                const emailCount = ref.emailAttempts || 0;
                const contactCountText = `ðŸ“ž ${phoneCount} ðŸ“§ ${emailCount}`;
                
                return `
                    <div class="referral-item" onclick="viewReferral(${ref.referralID})">
                        <div class="ref-urgent">${urgentIcon}</div>
                        <div class="ref-file" title="${ref.fileName || ''}" onclick="event.stopPropagation(); if('${ref.fileName}') viewSelectedFile();">${fileIcon}</div>
                        <div class="ref-name" title="${patientName}">${patientName}</div>
                        <div class="ref-status"><span class="status-badge ${statusClass}">${ref.referralStatus}</span></div>
                        <div class="ref-type ${typeClass}">${typeText}</div>
                        <div class="ref-dob">${dob}</div>
                        <div class="ref-age ${ageClass}">${age}</div>
                        <div class="ref-date">${receivedDate}</div>
                        <div class="ref-contact">${lastContact}</div>
                        <div class="ref-contact-count">${contactCountText}</div>
                        <div class="ref-service">${service}</div>
                        <div class="ref-physician ${physicianClass}">${physician}</div>
                        <div class="ref-location">${locationHTML}</div>
                        <div class="ref-phone" title="${phone}">${phone}</div>
                        <div class="ref-email" title="${email}">${email}</div>
                    </div>
                `;
            }).join('');
        }

        // Filter and sort referrals
        // OLD FUNCTION - Not used with SQLite backend (filtering done in Python)
        function filterAndSortReferrals() {
            // This function is no longer used - SQLite backend does filtering
            return allLoadedReferrals || [];
        }

        // Set sort mode
        function setSortMode(mode) {
            // Map old sort modes to new backend format
            const sortMap = {
                'id': { by: 'id', order: 'asc' },
                'name-az': { by: 'name', order: 'asc' },
                'attempt-old': { by: 'lastAttempt', order: 'asc' },
                'attempt-new': { by: 'lastAttempt', order: 'desc' },
                'received-new': { by: 'received', order: 'desc' },
                'received-old': { by: 'received', order: 'asc' }
            };
            
            if (sortMap[mode]) {
                currentSort = sortMap[mode];
                currentSortMode = mode; // Keep for button state
                
                // Update button states
                document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
                const btnId = {
                    'id': 'sortID',
                    'name-az': 'sortNameAZ',
                    'attempt-old': 'sortAttemptOld',
                    'attempt-new': 'sortAttemptNew',
                    'received-new': 'sortReceivedNew',
                    'received-old': 'sortReceivedOld'
                }[mode];
                if (btnId) document.getElementById(btnId).classList.add('active');
                
                // Reload with new sort
                loadReferrals(true);
            }
        }

        // Filter by status
        function filterByStatus(status) {
			// Handle "All" button - clears everything
			if (status === 'all') {
				currentFilter = [];
				// Update all buttons
				document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
				event.target.classList.add('active');
				loadReferrals(true);
				return;
			}
			
			// Define mutually exclusive groups
			const typeGroup = ['new', 'previous', 'partner'];
			const statusGroup = ['new-referral', 'pending', 'info-received', 'completed', 'deferred'];
			const contactGroup = ['contact-2days', 'contact-3days', 'contact-7days', 'no-contact'];
			const emailGroup = ['no-email'];
			
			// Check if this filter is already active (toggle off)
			const index = currentFilter.indexOf(status);
			if (index > -1) {
				// Filter already active, remove it (toggle off)
				currentFilter.splice(index, 1);
				event.target.classList.remove('active');
				
				// If no filters left, activate "All"
				if (currentFilter.length === 0) {
					const allButton = document.querySelector('.filter-btn');
					allButton.classList.add('active');
				}
				
				loadReferrals(true);
				return;
			}
			
			// Find which group this filter belongs to
			let group = null;
			if (typeGroup.includes(status)) group = typeGroup;
			else if (statusGroup.includes(status)) group = statusGroup;
			else if (contactGroup.includes(status)) group = contactGroup;
			else if (emailGroup.includes(status)) group = emailGroup;
			
			// Remove any filters from the same group (mutual exclusivity)
			if (group) {
				currentFilter = currentFilter.filter(f => !group.includes(f));
				
				// Remove active class from all buttons in this group
				group.forEach(filterName => {
					const btn = Array.from(document.querySelectorAll('.filter-btn')).find(
						b => b.onclick && b.onclick.toString().includes(`'${filterName}'`)
					);
					if (btn) btn.classList.remove('active');
				});
			}
			
			// Add the new filter
			currentFilter.push(status);
			event.target.classList.add('active');
			
			// Deactivate "All" button
			const allButton = document.querySelector('.filter-btn');
			allButton.classList.remove('active');
			
			console.log('Active filters:', currentFilter); // Debug logging
			
			// Reload with new filters
			loadReferrals(true);
		}

        // Filter referrals (called by search input)
        function filterReferrals() { loadReferrals(true); }

        // Reset filters
        function resetFilters() {
            // Clear all filters
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('searchBox').value = '';
            currentFilter = [];  // Clear filter array (not string 'all')
            currentSort = { by: 'id', order: 'asc' };  // Reset sort
            currentSortMode = 'id';
            
            // Reset button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.filter-btn').classList.add('active');  // Activate "All"
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('sortID').classList.add('active');
            
            // Reload data from backend
            loadReferrals(true);
            updateKPIs();
        }

		function openAddReferralModal() {
			if (isReadOnly) {
				document.getElementById('currentFile').textContent = 'Error: Cannot add referrals in read-only mode';
				document.getElementById('statusBar').style.color = '#e74c3c';
				return;
			}
			
			currentEditingReferral = null;
			document.getElementById('referralModalTitle').textContent = 'Add New Referral';
			document.getElementById('referralForm').reset();
			initializeDatePickers();
			
			closePdfViewer();
			currentFileObjectURL = null;
			document.getElementById('viewFileBtn').style.display = 'none';
			
			openModal('referralModal');
			document.querySelector('#referralModal .modal-body').scrollTop = 0;
		}

        function viewReferral(id) {
            alert('View referral #' + id + ' - coming soon');
        }

		function editReferralById(id) {
			if (isReadOnly) {
				document.getElementById('currentFile').textContent = 'Error: Cannot edit in read-only mode';
				document.getElementById('statusBar').style.color = '#e74c3c';
				return;
			}
			
			const referral = allLoadedReferrals.find(r => r.referralID === id);
			if (!referral) return;
			
			currentEditingReferral = referral;
			document.getElementById('referralModalTitle').textContent = 'Edit Referral';
			
			// Populate all fields
			document.getElementById('referralDate').value = referral.referralDate || '';
			document.getElementById('receivedDate').value = referral.receivedDate || '';
			document.getElementById('fileName').value = referral.fileName || '';
			document.getElementById('referringPhysician').value = referral.referringPhysicianName || '';
			document.getElementById('billingNumber').value = referral.referringPhysicianBilling || '';
			document.getElementById('physicianFax').value = referral.referringPhysicianFax || '';
			document.getElementById('physicianPhone').value = referral.referringPhysicianPhone || '';
			document.getElementById('physicianEmail').value = referral.referringPhysicianEmail || '';
			
			document.getElementById('requestedLocation').value = referral.requestedLocation || '';
			document.getElementById('requestedPhysician').value = referral.requestedPhysician || '';
			document.getElementById('urgent').checked = referral.urgent || false;
			document.getElementById('serviceRequested').value = referral.serviceRequested || '';
			document.getElementById('subServiceRequested').value = referral.subServiceRequested || '';
			document.getElementById('referralType').value = referral.referralType || '';
			
			document.getElementById('patientPID').value = referral.patientPID || '';
			document.getElementById('patientMRN').value = referral.patientMRN || '';
			document.getElementById('patientFirstName').value = referral.patientFirstName || '';
			document.getElementById('patientMiddleName').value = referral.patientMiddleName || '';
			document.getElementById('patientLastName').value = referral.patientLastName || '';
			document.getElementById('patientDOB').value = referral.patientDOB || '';
			document.getElementById('patientPhone').value = referral.patientPhone || '';
			document.getElementById('patientEmail').value = referral.patientEmail || '';
			document.getElementById('patientAddress').value = referral.patientAddress || '';
			document.getElementById('patientHC').value = referral.patientHC || '';
			document.getElementById('patientGenderAtBirth').value = referral.patientGenderAtBirth || '';
			document.getElementById('emergencyContact').value = referral.emergencyContact || '';
			document.getElementById('emergencyContactRelationship').value = referral.emergencyContactRelationship || '';
			
			// Calculate patient age
			updateAgeField('patientDOB', 'patientAge');
			
			// Partner fields
			const hasPartner = referral.partnerFirstName || referral.partnerLastName;
			document.getElementById('enablePartner').checked = hasPartner;
			togglePartnerFields();
			
			document.getElementById('partnerPID').value = referral.partnerPID || '';
			document.getElementById('partnerMRN').value = referral.partnerMRN || '';
			document.getElementById('partnerFirstName').value = referral.partnerFirstName || '';
			document.getElementById('partnerMiddleName').value = referral.partnerMiddleName || '';
			document.getElementById('partnerLastName').value = referral.partnerLastName || '';
			document.getElementById('partnerDOB').value = referral.partnerDOB || '';
			document.getElementById('partnerPhone').value = referral.partnerPhone || '';
			document.getElementById('partnerEmail').value = referral.partnerEmail || '';
			document.getElementById('partnerAddress').value = referral.partnerAddress || '';
			document.getElementById('partnerHC').value = referral.partnerHC || '';
			document.getElementById('partnerGenderAtBirth').value = referral.partnerGenderAtBirth || '';
			document.getElementById('partnerEmergencyContact').value = referral.partnerEmergencyContact || '';
			document.getElementById('partnerEmergencyContactRelationship').value = referral.partnerEmergencyContactRelationship || '';
			
			// Calculate partner age
			updateAgeField('partnerDOB', 'partnerAge');
			
			initializeDatePickers();
			
			currentFilePath = null;
			currentFileObjectURL = null;
			closePdfViewer();

			if (referral.fileName) {
				currentFilePath = referral.fileName;
				document.getElementById('fileName').value = referral.fileName;
				document.getElementById('viewFileBtn').style.display = 'inline-block';
				document.getElementById('viewFileBtn').textContent = 'View';
			} else {
				document.getElementById('fileName').value = '';
				document.getElementById('viewFileBtn').style.display = 'none';
			}

			openModal('referralModal');
			document.querySelector('#referralModal .modal-body').scrollTop = 0;
		}

        function quickContact(id) {
            alert('Quick contact for referral #' + id + ' - coming soon');
        }
		
		function openModal(id) {
			document.getElementById(id).classList.add('active');
			checkDualModal();
		}

		function closeModal(id) {
			if (id === 'referralModal') {
				// Close PDF viewer too when referral modal closes
				closePdfViewer();
			}
			document.getElementById(id).classList.remove('active');
			checkDualModal();
		}

		function checkDualModal() {
			const referralModalOpen = document.getElementById('referralModal').classList.contains('active');
			const pdfOpen = document.getElementById('pdfViewerModal').style.display === 'flex';

			if (referralModalOpen && pdfOpen) {
				document.body.classList.add('dual-modal');
			} else {
				document.body.classList.remove('dual-modal');
			}
		}

		function openPdfViewer() {
			if (!currentFileObjectURL) return;
			document.getElementById('pdfFrame').src = currentFileObjectURL;
			document.getElementById('pdfViewerModal').style.display = 'flex';
			checkDualModal();
		}

		function closePdfViewer() {
			document.getElementById('pdfViewerModal').style.display = 'none';
			document.getElementById('pdfFrame').src = '';
			document.body.classList.remove('dual-modal');
			// Don't clear currentFileObjectURL - keep it so it can be reopened
		}

		// Current file path stored for reuse
		let currentFilePath = null;
		let currentFileObjectURL = null;

		// Select file via Python dialog
		async function selectFile() {
			const filePath = await eel.open_file_dialog()();
			
			if (filePath) {
				// Store the full path
				currentFilePath = filePath;
				
				// Show just the filename in the input
				const fileName = filePath.split('\\').pop().split('/').pop();
				document.getElementById('fileName').value = filePath;
				
				// Show view button
				document.getElementById('viewFileBtn').style.display = 'inline-block';
				
				// Auto-open the viewer
				await openFileFromPath(filePath);
			}
		}

		// Open file from a stored path (works for both new and edit)
		async function openFileFromPath(filePath) {
			if (!filePath) return;
			
			document.getElementById('viewFileBtn').textContent = 'Loading...';
			
			try {
				const result = await eel.get_file_content(filePath)();
				
				if (result.status === 'success') {
					// Revoke previous URL to free memory
					if (currentFileObjectURL) {
						URL.revokeObjectURL(currentFileObjectURL);
						currentFileObjectURL = null;
					}
					
					// Create blob URL from base64
					const byteCharacters = atob(result.content);
					const byteArray = new Uint8Array(byteCharacters.length);
					for (let i = 0; i < byteCharacters.length; i++) {
						byteArray[i] = byteCharacters.charCodeAt(i);
					}
					const blob = new Blob([byteArray], { type: result.mime });
					currentFileObjectURL = URL.createObjectURL(blob);
					
					// Open viewer
					openPdfViewer();
					document.getElementById('viewFileBtn').textContent = 'View';
					
				} else {
					document.getElementById('currentFile').textContent = 'Error: ' + result.message;
					document.getElementById('statusBar').style.color = '#e74c3c';
					document.getElementById('viewFileBtn').textContent = 'View';
				}
			} catch(e) {
				document.getElementById('currentFile').textContent = 'Error loading file: ' + e.message;
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('viewFileBtn').textContent = 'View';
			}
		}

		// View button clicked - reopen or load
		async function viewSelectedFile() {
			if (currentFileObjectURL) {
				// Already loaded - just reopen viewer
				openPdfViewer();
			} else if (currentFilePath) {
				// Has path but no loaded content - load it
				await openFileFromPath(currentFilePath);
			}
		}

		// Populate select options in modal
		function populateSelectOptions() {
			if (!selectOptions) return;
			
			const options = selectOptions;
			
			// Requested locations
			populateSelect('requestedLocation', options.requestedLocations || []);
			
			// Requested physicians
			populateSelect('requestedPhysician', options.requestedPhysicians || []);
			
			// Services
			populateSelect('serviceRequested', options.servicesRequested || []);
			
			// Referral Type
			populateSelect('referralType', options.referralType || []);
			
			// Gender
			populateSelect('patientGenderAtBirth', options.genderAtBirth || []);
			populateSelect('partnerGenderAtBirth', options.genderAtBirth || []);
		}

		function populateSelect(id, values) {
			const select = document.getElementById(id);
			const currentValue = select.value;
			const firstOption = select.options[0].outerHTML; // Keep first option
			select.innerHTML = firstOption;
			values.forEach(val => {
				const opt = document.createElement('option');
				opt.value = val;
				opt.textContent = val;
				select.appendChild(opt);
			});
			if (currentValue) {
				select.value = currentValue;
			}
		}

		// Calculate age from date of birth
		function calculateAge(dobString) {
			if (!dobString) return '';
			
			const birthDate = new Date(dobString);
			const today = new Date();
			let age = today.getFullYear() - birthDate.getFullYear();
			const monthDiff = today.getMonth() - birthDate.getMonth();
			
			if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
				age--;
			}
			
			return age;
		}
		
		// Update age field and color based on DOB
		function updateAgeField(dobFieldId, ageFieldId) {
			const dobValue = document.getElementById(dobFieldId).value;
			const ageField = document.getElementById(ageFieldId);
			
			if (dobValue) {
				const age = calculateAge(dobValue);
				ageField.value = age;
				
				// Color red if > 43
				if (age > 43) {
					ageField.style.color = '#e74c3c';
					ageField.style.fontWeight = 'bold';
				} else {
					ageField.style.color = '';
					ageField.style.fontWeight = '';
				}
			} else {
				ageField.value = '';
				ageField.style.color = '';
				ageField.style.fontWeight = '';
			}
		}

		// Initialize date pickers in modal
		function initializeDatePickers() {
			const datepickers = document.querySelectorAll('.datepicker');
			datepickers.forEach(input => {
				flatpickr(input, {
					dateFormat: 'Y-m-d',
					allowInput: true,
					onChange: function(selectedDates, dateStr, instance) {
						// Update age when DOB changes
						if (input.id === 'patientDOB') {
							updateAgeField('patientDOB', 'patientAge');
						} else if (input.id === 'partnerDOB') {
							updateAgeField('partnerDOB', 'partnerAge');
						}
					}
				});
			});
			
			// Also calculate age on manual input
			document.getElementById('patientDOB').addEventListener('input', function() {
				updateAgeField('patientDOB', 'patientAge');
			});
			document.getElementById('partnerDOB').addEventListener('input', function() {
				updateAgeField('partnerDOB', 'partnerAge');
			});
		}

		// Save referral
		async function saveReferral() {
			if (isReadOnly) {
				document.getElementById('currentFile').textContent = 'Error: Cannot save in read-only mode';
				document.getElementById('statusBar').style.color = '#e74c3c';
				return;
			}
			
			// Validate required fields
			const receivedDate = document.getElementById('receivedDate').value;
			const referringPhysician = document.getElementById('referringPhysician').value;
			const requestedLocation = document.getElementById('requestedLocation').value;
			const requestedPhysician = document.getElementById('requestedPhysician').value;
			const referralType = document.getElementById('referralType').value;
			const serviceRequested = document.getElementById('serviceRequested').value;
			const patientFirstName = document.getElementById('patientFirstName').value;
			const patientLastName = document.getElementById('patientLastName').value;
			const patientDOB = document.getElementById('patientDOB').value;
			const patientPhone = document.getElementById('patientPhone').value;
			const patientEmail = document.getElementById('patientEmail').value;
			
			// Check required fields
			if (!receivedDate) {
				document.getElementById('currentFile').textContent = 'Error: Received Date is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('receivedDate').focus();
				return;
			}
			if (!referringPhysician) {
				document.getElementById('currentFile').textContent = 'Error: Referring Physician Name is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('referringPhysician').focus();
				return;
			}
			if (!requestedLocation) {
				document.getElementById('currentFile').textContent = 'Error: Requested Location is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('requestedLocation').focus();
				return;
			}
			if (!requestedPhysician) {
				document.getElementById('currentFile').textContent = 'Error: Requested Physician is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('requestedPhysician').focus();
				return;
			}
			if (!referralType) {
				document.getElementById('currentFile').textContent = 'Error: Referral Type is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('referralType').focus();
				return;
			}
			if (!serviceRequested) {
				document.getElementById('currentFile').textContent = 'Error: Service Requested is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('serviceRequested').focus();
				return;
			}
			if (!patientFirstName) {
				document.getElementById('currentFile').textContent = 'Error: Patient First Name is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('patientFirstName').focus();
				return;
			}
			if (!patientLastName) {
				document.getElementById('currentFile').textContent = 'Error: Patient Last Name is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('patientLastName').focus();
				return;
			}
			if (!patientDOB) {
				document.getElementById('currentFile').textContent = 'Error: Patient Date of Birth is required';
				document.getElementById('statusBar').style.color = '#e74c3c';
				document.getElementById('patientDOB').focus();
				return;
			}
			
			// Collect form data
			const referralData = {
				// Referral info
				referralDate: document.getElementById('referralDate').value,
				receivedDate: receivedDate,
				fileName: document.getElementById('fileName').value,
				referringPhysicianName: referringPhysician,
				referringPhysicianBilling: document.getElementById('billingNumber').value,
				referringPhysicianFax: document.getElementById('physicianFax').value,
				referringPhysicianPhone: document.getElementById('physicianPhone').value,
				referringPhysicianEmail: document.getElementById('physicianEmail').value,
				
				// Service info
				requestedLocation: requestedLocation,
				requestedPhysician: requestedPhysician,
				urgent: document.getElementById('urgent').checked,
				serviceRequested: serviceRequested,
				subServiceRequested: document.getElementById('subServiceRequested').value,
				referralType: referralType,
				
				// Patient info
				patientPID: document.getElementById('patientPID').value,
				patientMRN: document.getElementById('patientMRN').value,
				patientFirstName: patientFirstName,
				patientMiddleName: document.getElementById('patientMiddleName').value,
				patientLastName: patientLastName,
				patientDOB: patientDOB,
				patientPhone: patientPhone,
				patientEmail: patientEmail,
				patientAddress: document.getElementById('patientAddress').value,
				patientHC: document.getElementById('patientHC').value,
				patientGenderAtBirth: document.getElementById('patientGenderAtBirth').value,
				emergencyContact: document.getElementById('emergencyContact').value,
				emergencyContactRelationship: document.getElementById('emergencyContactRelationship').value,
				
				// Partner info
				partnerPID: document.getElementById('partnerPID').value,
				partnerMRN: document.getElementById('partnerMRN').value,
				partnerFirstName: document.getElementById('partnerFirstName').value,
				partnerMiddleName: document.getElementById('partnerMiddleName').value,
				partnerLastName: document.getElementById('partnerLastName').value,
				partnerDOB: document.getElementById('partnerDOB').value,
				partnerPhone: document.getElementById('partnerPhone').value,
				partnerEmail: document.getElementById('partnerEmail').value,
				partnerAddress: document.getElementById('partnerAddress').value,
				partnerHC: document.getElementById('partnerHC').value,
				partnerGenderAtBirth: document.getElementById('partnerGenderAtBirth').value,
				partnerEmergencyContact: document.getElementById('partnerEmergencyContact').value,
				partnerEmergencyContactRelationship: document.getElementById('partnerEmergencyContactRelationship').value,
				
				// Referral handling (defaults for new referrals, preserve for edits)
				referralStatus: currentEditingReferral ? currentEditingReferral.referralStatus : 'New',
				lastAttemptDate: currentEditingReferral ? currentEditingReferral.lastAttemptDate : null,
				lastAttemptTime: currentEditingReferral ? currentEditingReferral.lastAttemptTime : null,
				lastAttemptMode: currentEditingReferral ? currentEditingReferral.lastAttemptMode : null,
				lastAttemptComment: currentEditingReferral ? currentEditingReferral.lastAttemptComment : null,
				attemptHistory: currentEditingReferral ? currentEditingReferral.attemptHistory : [],
				faxedBackDate: currentEditingReferral ? currentEditingReferral.faxedBackDate : null,
				completeInfoReceivedDate: currentEditingReferral ? currentEditingReferral.completeInfoReceivedDate : null,
				taskedToPhysicianAdmin: currentEditingReferral ? currentEditingReferral.taskedToPhysicianAdmin : null,
				referralCompleteDate: currentEditingReferral ? currentEditingReferral.referralCompleteDate : null,
				notes: currentEditingReferral ? currentEditingReferral.notes : null,
				notesDate: currentEditingReferral ? currentEditingReferral.notesDate : null,
				notesHistory: currentEditingReferral ? currentEditingReferral.notesHistory : []
			};
			
			let result;
			if (currentEditingReferral) {
				// Update existing
				referralData.referralID = currentEditingReferral.referralID;
				referralData.addedToDBDate = currentEditingReferral.addedToDBDate;
				result = await eel.update_referral(currentEditingReferral.referralID, referralData)();
				
				// Update in local database
				const index = allLoadedReferrals.findIndex(r => r.referralID === currentEditingReferral.referralID);
				if (index !== -1) {
					allLoadedReferrals[index] = referralData;
				}
			} else {
				// Add new
				result = await eel.add_referral(referralData)();
				if (result.status === 'success') {
					allLoadedReferrals.push(result.referral);
				}
			}
			
			if (result.status === 'success') {
				unsavedChanges = 0;
				renderReferralList();
				updateKPIs();
				closeModal('referralModal');
				document.getElementById('currentFile').textContent = 'DB\\referrals.json - Referral saved';
				document.getElementById('statusBar').style.color = '#27ae60';
				setTimeout(() => {
					document.getElementById('currentFile').textContent = 'DB\\referrals.json';
					document.getElementById('statusBar').style.color = '#666';
				}, 3000);
			} else {
				document.getElementById('currentFile').textContent = 'Error: ' + result.message;
				document.getElementById('statusBar').style.color = '#e74c3c';
			}
		}
		
		// Reset and open add referral modal  
		function openAddReferralModal() {
			if (isReadOnly) {
				document.getElementById('currentFile').textContent = 'Error: Cannot add referrals in read-only mode';
				document.getElementById('statusBar').style.color = '#e74c3c';
				return;
			}
			
			currentEditingReferral = null;
			currentFilePath = null;
			currentFileObjectURL = null;
			
			document.getElementById('referralModalTitle').textContent = 'Add New Referral';
			document.getElementById('referralForm').reset();
			document.getElementById('viewFileBtn').style.display = 'none';
			closePdfViewer();
			
			initializeDatePickers();
			openModal('referralModal');
		}
		
		function togglePartnerFields() {
			const enabled = document.getElementById('enablePartner').checked;
			const partnerSection = document.getElementById('partnerSection');
			
			if (enabled) {
				partnerSection.style.opacity = '1';
				partnerSection.style.pointerEvents = 'auto';
			} else {
				partnerSection.style.opacity = '0.4';
				partnerSection.style.pointerEvents = 'none';
				// Clear partner fields
				document.querySelectorAll('#partnerSection input, #partnerSection select').forEach(field => {
					field.value = '';
				});
			}
		}

    
        // Infinite scroll for referral list
        document.getElementById('referralList')?.addEventListener('scroll', async function(e) {
            const container = e.target;
            const scrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            
            if (scrollTop + clientHeight >= scrollHeight - 200) {
                if (hasMore && !isLoading) {
                    await loadReferrals(false);
                }
            }
        });
    </script>
</body>
</html>
